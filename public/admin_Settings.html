<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin Settings - Make The Difference</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = { darkMode: 'class' };
	</script>
	<script>
		(function(){
			try {
				var theme = localStorage.getItem('color-theme');
				if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
					document.documentElement.classList.add('dark');
				} else {
					document.documentElement.classList.remove('dark');
				}
			} catch(e) {}
		})();
	</script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/admin-layout.css">
	<link rel="stylesheet" href="css/admin-sidebar-fix.css">
	<script src="js/include-admin-header.js" defer></script>
	<script src="js/include-admin-sidebar.js" defer></script>
	<script src="js/api.js" defer></script>
</head>
<body class="admin-layout bg-gray-50 dark:bg-gray-900" data-page="settings">
	<div id="admin-sidebar-container"></div>
	<div id="admin-header-container" data-page-title="Settings"></div>
	<main class="admin-main-content w-full bg-transparent dark:bg-transparent">
		<div class="admin-content-container p-6">
			<div class="mb-6 flex items-center justify-between">
				<h1 class="text-2xl font-bold">General Settings</h1>
				<div class="flex gap-2">
					<button id="settingsRefresh" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg"><i class="fas fa-sync-alt"></i></button>
					<button id="settingsSave" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2"><i class="fas fa-save"></i>Save</button>
				</div>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<div class="lg:col-span-2 space-y-6">
					<section class="bg-white/80 dark:bg-gray-800/80 rounded-xl shadow p-6">
						<h2 class="text-lg font-semibold mb-4">Site Information</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm mb-1">Site Title</label>
								<input id="siteTitle" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
							</div>
							<div>
								<label class="block text-sm mb-1">Contact Email</label>
								<input id="contactEmail" type="email" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
							</div>
							<div class="md:col-span-2">
								<label class="block text-sm mb-1">Site Description</label>
								<textarea id="siteDescription" rows="3" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
							</div>
						</div>
					</section>

					<section class="bg-white/80 dark:bg-gray-800/80 rounded-xl shadow p-6">
						<h2 class="text-lg font-semibold mb-4">Homepage</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="md:col-span-2">
								<label class="block text-sm mb-1">Homepage Content</label>
								<textarea id="homepageContent" rows="5" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
							</div>
							<div>
								<label class="block text-sm mb-1">Homepage Banner URL</label>
								<input id="homepageBanner" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
							</div>
							<div>
								<label class="block text-sm mb-1">Services (comma separated)</label>
								<input id="services" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Mentorship,Internships,Workshops" />
							</div>
						</div>
					</section>

					<section class="bg-white/80 dark:bg-gray-800/80 rounded-xl shadow p-6">
						<h2 class="text-lg font-semibold mb-4">Social Links</h2>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
							<div>
								<label class="block text-sm mb-1">Facebook</label>
								<input id="facebookLink" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="https://facebook.com/..." />
							</div>
							<div>
								<label class="block text-sm mb-1">Twitter</label>
								<input id="twitterLink" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="https://x.com/..." />
							</div>
							<div>
								<label class="block text-sm mb-1">Instagram</label>
								<input id="instagramLink" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="https://instagram.com/..." />
							</div>
						</div>
					</section>
				</div>

				<div class="space-y-6">
					<section class="bg-white/80 dark:bg-gray-800/80 rounded-xl shadow p-6">
						<h2 class="text-lg font-semibold mb-4">Branding</h2>
						<div class="grid grid-cols-1 gap-4">
							<div>
								<label class="block text-sm mb-1">Logo</label>
								<div class="flex items-center gap-4">
									<img id="logoPreview" src="" alt="Logo" class="h-12 w-12 object-contain bg-white dark:bg-gray-700 border rounded" />
									<input id="logoFile" type="file" accept="image/*" class="hidden">
									<label for="logoFile" class="inline-flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 rounded-md cursor-pointer">
										<i class="fas fa-upload"></i><span>Choose file</span>
									</label>
									<span id="logoFileName" class="text-sm text-gray-600 dark:text-gray-300 truncate max-w-[200px]"></span>
								</div>
							</div>
							<div>
								<label class="block text-sm mb-1">Favicon</label>
								<div class="flex items-center gap-4">
									<img id="faviconPreview" src="" alt="Favicon" class="h-10 w-10 object-contain bg-white dark:bg-gray-700 border rounded" />
									<input id="faviconFile" type="file" accept="image/*" class="hidden">
									<label for="faviconFile" class="inline-flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 rounded-md cursor-pointer">
										<i class="fas fa-upload"></i><span>Choose file</span>
									</label>
									<span id="faviconFileName" class="text-sm text-gray-600 dark:text-gray-300 truncate max-w-[200px]"></span>
								</div>
							</div>
						</div>
					</section>

					<section class="bg-white/80 dark:bg-gray-800/80 rounded-xl shadow p-6">
						<h2 class="text-lg font-semibold mb-4">Maintenance</h2>
						<div class="grid grid-cols-1 gap-4">
							<div>
								<label class="block text-sm mb-1">Maintenance Mode</label>
								<select id="maintenanceMode" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
									<option value="off">Off</option>
									<option value="on">On</option>
								</select>
							</div>
							<div>
								<label class="block text-sm mb-1">Maintenance Pages</label>
								<div class="flex items-center gap-3 mb-2">
									<div class="relative flex-1">
										<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
										<input id="maintenanceFilter" placeholder="Filter pages..." class="w-full pl-10 pr-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
									</div>
									<label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="maintenanceSelectAll" class="h-4 w-4"><span>Select all</span></label>
								</div>
								<div id="maintenanceChecklist" class="max-h-64 overflow-auto border rounded-lg divide-y bg-white dark:bg-gray-700"></div>
								<input id="maintenancePages" class="hidden" />
							</div>
						</div>
					</section>
				</div>
			</div>

			<div id="settingsToast" class="hidden fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-[21000]"></div>
		</div>
	</main>

	<script>
		(function(){
			const els = {
				siteTitle: null, contactEmail: null, siteDescription: null,
				homepageContent: null, homepageBanner: null, services: null,
				facebookLink: null, twitterLink: null, instagramLink: null,
				maintenanceMode: null, maintenancePages: null,
				maintenanceChecklist: null, maintenanceFilter: null, maintenanceSelectAll: null,
				logoFile: null, logoPreview: null, logoFileName: null,
				faviconFile: null, faviconPreview: null, faviconFileName: null,
				refreshBtn: null, saveBtn: null, toast: null
			};

			// Expanded list: include base, /base, base.html, /base.html
			const P = (name) => [name, `/${name}`, `${name}.html`, `/${name}.html`];
			const ALL_PAGES = [
				...P('home'),
				...P('contact'),
				...P('about'),
				...P('help-center'),
				...P('profile'),
				...P('dashboard'),
				...P('service'),
				...P('services'),
				...P('scholarship'),
				...P('scholarships'),
				...P('partnership'),
				...P('partners'),
				...P('applications'),
				...P('notifications'),
				...P('signup'),
				...P('login'),
				...P('reset-password'),
				...P('logout'),
				...P('test-logout-fix'),
				'admin_dashboard.html','/admin_dashboard.html',
				'admin_users.html','/admin_users.html',
				'admin_rolesPermissions.html','/admin_rolesPermissions.html',
				'admin_scholarship.html','/admin_scholarship.html',
				'admin_applications.html','/admin_applications.html',
				'admin_partners.html','/admin_partners.html',
				'admin_services.html','/admin_services.html',
				'admin_email_template.html','/admin_email_template.html',
				'admin_analytics.html','/admin_analytics.html',
				'admin_Settings.html','/admin_Settings.html',
				'admin_it_settings.html','/admin_it_settings.html'
			];

			function showToast(message, type){
				const n = els.toast; if(!n) return;
				n.textContent = message;
				n.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-[21000] ${type==='error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
				n.classList.remove('hidden');
				setTimeout(()=>{ n.classList.add('hidden'); }, 2500);
			}

			function authHeaders(){
				try{
					const token = localStorage.getItem('token');
					return token ? { 'Authorization': `Bearer ${token}` } : {};
				}catch(e){ return {}; }
			}

			function toComma(list){ try{ const arr = JSON.parse(list || '[]'); return Array.isArray(arr)? arr.join(',') : ''; } catch{ return ''; } }
			function toJsonArray(comma){ const arr = (comma || '').split(',').map(s=>s.trim()).filter(Boolean); return JSON.stringify(arr); }
			function asImageSrc(value){ if(!value) return ''; if(/^https?:\/\//.test(value)) return value; return `uploads/${value}`; }

			function renderMaintenanceChecklist(selected){
				const wrap = els.maintenanceChecklist; if(!wrap) return;
				wrap.innerHTML = '';
				const chosen = new Set((selected || []).map(s => String(s).toLowerCase()));
				ALL_PAGES.forEach((path)=>{
					const display = path;
					const row = document.createElement('label');
					row.className = 'flex items-center justify-between px-3 py-2';
					row.dataset.path = String(path).toLowerCase();
					row.innerHTML = `<span class="text-sm">${display}</span><input type="checkbox" class="h-4 w-4" data-page>`;
					const cb = row.querySelector('input[type="checkbox"]');
					cb.checked = chosen.has(row.dataset.path) || chosen.has(row.dataset.path.replace(/^\//,'')) || chosen.has(row.dataset.path.replace(/\.html$/,''));
					wrap.appendChild(row);
				});
				updateSelectAllState();
			}

			function getCheckedPages(){
				const cbs = els.maintenanceChecklist ? els.maintenanceChecklist.querySelectorAll('input[type="checkbox"][data-page]') : [];
				const arr = [];
				cbs.forEach(cb=>{ if(cb.checked){ const label = cb.closest('label'); if(label){ arr.push(label.querySelector('span').textContent); } } });
				return arr;
			}

			function updateSelectAllState(){
				if(!els.maintenanceChecklist || !els.maintenanceSelectAll) return;
				const cbs = els.maintenanceChecklist.querySelectorAll('input[type="checkbox"][data-page]');
				const total = cbs.length;
				const checked = Array.from(cbs).filter(cb=>cb.checked).length;
				els.maintenanceSelectAll.checked = (total>0 && checked === total);
				els.maintenanceSelectAll.indeterminate = (checked>0 && checked<total);
			}

			function applyMaintenanceFilter(){
				if(!els.maintenanceChecklist || !els.maintenanceFilter) return;
				const q = (els.maintenanceFilter.value || '').toLowerCase();
				Array.from(els.maintenanceChecklist.children).forEach(row=>{
					const match = row.dataset.path.includes(q);
					row.classList.toggle('hidden', !match);
				});
			}

			async function loadSettings(){
				try{
					const res = await fetch('/api/settings', { headers: { ...authHeaders() } });
					if(!res.ok) throw new Error('Failed to load settings');
					const data = await res.json();
					els.siteTitle.value = data.site_title || '';
					els.contactEmail.value = data.contact_email || '';
					els.siteDescription.value = data.site_description || '';
					els.homepageContent.value = data.homepage_content || '';
					els.homepageBanner.value = data.homepage_banner || '';
					els.services.value = toComma(data.services || '[]');
					els.facebookLink.value = data.facebook_link || '';
					els.twitterLink.value = data.twitter_link || '';
					els.instagramLink.value = data.instagram_link || '';
					let mode = data.maintenance_mode;
					if (mode === 1 || mode === true) mode = 'on';
					if (mode === 0 || mode === false || mode == null) mode = 'off';
					els.maintenanceMode.value = (mode === 'on' ? 'on' : 'off');
					let selected = [];
					if (Array.isArray(data.maintenance_pages)) {
						selected = data.maintenance_pages;
					} else if (typeof data.maintenance_pages === 'string') {
						try { selected = JSON.parse(data.maintenance_pages) || []; } catch { selected = []; }
					}
					renderMaintenanceChecklist(selected);
					els.logoPreview.src = asImageSrc(data.logo_url);
					els.faviconPreview.src = asImageSrc(data.favicon_url);
				} catch(err){ showToast(err.message || 'Error loading settings','error'); }
			}

			async function saveSettings(){
				try{
					const fd = new FormData();
					fd.append('siteTitle', els.siteTitle.value || '');
					fd.append('contactEmail', els.contactEmail.value || '');
					fd.append('siteDescription', els.siteDescription.value || '');
					fd.append('homepageContent', els.homepageContent.value || '');
					fd.append('homepageBanner', els.homepageBanner.value || '');
					fd.append('services', toJsonArray(els.services.value));
					fd.append('facebookLink', els.facebookLink.value || '');
					fd.append('twitterLink', els.twitterLink.value || '');
					fd.append('instagramLink', els.instagramLink.value || '');
					fd.append('maintenanceMode', els.maintenanceMode.value || 'off');
					const selectedPages = getCheckedPages();
					fd.append('maintenancePages', JSON.stringify(selectedPages));
					if (els.logoFile.files && els.logoFile.files[0]) fd.append('logo', els.logoFile.files[0]);
					if (els.faviconFile.files && els.faviconFile.files[0]) fd.append('favicon', els.faviconFile.files[0]);

					const res = await fetch('/api/settings', {
						method: 'POST',
						headers: { ...authHeaders() },
						body: fd
					});
					if(!res.ok) throw new Error('Failed to save settings');
					const data = await res.json();
					showToast('Settings saved','ok');
					els.logoPreview.src = asImageSrc(data.logo_url);
					els.faviconPreview.src = asImageSrc(data.favicon_url);
				} catch(err){ showToast(err.message || 'Error saving settings','error'); }
			}

			document.addEventListener('DOMContentLoaded', function(){
				els.siteTitle = document.getElementById('siteTitle');
				els.contactEmail = document.getElementById('contactEmail');
				els.siteDescription = document.getElementById('siteDescription');
				els.homepageContent = document.getElementById('homepageContent');
				els.homepageBanner = document.getElementById('homepageBanner');
				els.services = document.getElementById('services');
				els.facebookLink = document.getElementById('facebookLink');
				els.twitterLink = document.getElementById('twitterLink');
				els.instagramLink = document.getElementById('instagramLink');
				els.maintenanceMode = document.getElementById('maintenanceMode');
				els.maintenancePages = document.getElementById('maintenancePages');
				els.maintenanceChecklist = document.getElementById('maintenanceChecklist');
				els.maintenanceFilter = document.getElementById('maintenanceFilter');
				els.maintenanceSelectAll = document.getElementById('maintenanceSelectAll');
				els.logoFile = document.getElementById('logoFile');
				els.logoPreview = document.getElementById('logoPreview');
				els.logoFileName = document.getElementById('logoFileName');
				els.faviconFile = document.getElementById('faviconFile');
				els.faviconPreview = document.getElementById('faviconPreview');
				els.faviconFileName = document.getElementById('faviconFileName');
				els.refreshBtn = document.getElementById('settingsRefresh');
				els.saveBtn = document.getElementById('settingsSave');
				els.toast = document.getElementById('settingsToast');

				renderMaintenanceChecklist([]);
				els.maintenanceFilter && els.maintenanceFilter.addEventListener('input', applyMaintenanceFilter);
				if (els.maintenanceChecklist) {
					els.maintenanceChecklist.addEventListener('change', (e)=>{
						if (e.target && e.target.matches('input[type="checkbox"][data-page]')) {
							updateSelectAllState();
						}
					});
				}
				if (els.maintenanceSelectAll) {
					els.maintenanceSelectAll.addEventListener('change', ()=>{
						const cbs = els.maintenanceChecklist.querySelectorAll('input[type="checkbox"][data-page]');
						cbs.forEach(cb=>cb.checked = els.maintenanceSelectAll.checked);
					});
				}

				if (els.logoFile) {
					els.logoFile.addEventListener('change', () => {
						const f = els.logoFile.files && els.logoFile.files[0];
						if (f) {
							const reader = new FileReader();
							reader.onload = e => els.logoPreview.src = e.target.result;
							reader.readAsDataURL(f);
							els.logoFileName.textContent = f.name;
						} else {
							els.logoFileName.textContent = '';
						}
					});
				}
				if (els.faviconFile) {
					els.faviconFile.addEventListener('change', () => {
						const f = els.faviconFile.files && els.faviconFile.files[0];
						if (f) {
							const reader = new FileReader();
							reader.onload = e => els.faviconPreview.src = e.target.result;
							reader.readAsDataURL(f);
							els.faviconFileName.textContent = f.name;
						} else {
							els.faviconFileName.textContent = '';
						}
					});
				}

				els.refreshBtn && els.refreshBtn.addEventListener('click', loadSettings);
				els.saveBtn && els.saveBtn.addEventListener('click', saveSettings);

				loadSettings();
			});
		})();
	</script>
</body>
</html>
