<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                500: '#3b82f6', // blue-500
                600: '#2563eb', // blue-600
              }
            }
          }
        }
      }
    </script>
    <script src="js/maintenance-guard.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="prefetch" href="home.html">
    <link rel="prefetch" href="admin_dashboard.html">
    <link rel="prefetch" href="scholarship.html">
    <link rel="prefetch" href="login.html">
    <link rel="prefetch" href="signup.html">
    <style>
        @keyframes fadeOut {
            0% { 
                opacity: 1;
                transform: translateY(0);
                max-height: 200px;
                margin-bottom: 2rem;
            }
            100% { 
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
                margin-bottom: 0;
                padding: 0;
            }
        }
        .fade-out {
            animation: fadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .welcome-section {
            transform-origin: top;
            will-change: transform, opacity, max-height;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Shared Header -->
    <div id="user-header-container"></div>

    <!-- Shared Sidebar -->
    <div id="user-sidebar-container"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24 md:ml-56">
        <!-- Welcome Section -->
        <div id="welcomeSection" class="welcome-section rounded-xl shadow-md p-8 mb-8 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
                <div>
                    <h2 class="text-2xl lg:text-3xl font-extrabold mb-2 tracking-tight">Welcome, <span id="welcomeName"></span> ðŸ‘‹</h2>
                    <p class="text-blue-50/90 max-w-2xl">Track your scholarship journey, manage applications, and discover new opportunities tailored for you.</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="scholarship.html" class="inline-flex items-center gap-2 bg-white text-blue-700 hover:bg-blue-50 rounded-lg px-4 py-2 font-medium transition">
                        <i class="fas fa-search"></i> Find Scholarships
                    </a>
                    <a href="profile.html" class="inline-flex items-center gap-2 bg-blue-500/30 hover:bg-blue-500/40 rounded-lg px-4 py-2 font-medium transition">
                        <i class="fas fa-user"></i> Update Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 transition hover:shadow-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                        <i class="fas fa-graduation-cap text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Applications</h3>
                        <p class="text-3xl font-extrabold text-gray-900 dark:text-white" id="activeApplications">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 transition hover:shadow-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400">
                        <i class="fas fa-star text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Available Scholarships</h3>
                        <p class="text-3xl font-extrabold text-gray-900 dark:text-white" id="availableScholarships">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 transition hover:shadow-lg hidden md:block">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg. Processing</h3>
                        <p class="text-3xl font-extrabold text-gray-900 dark:text-white" id="avgProcessing">â€”</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-6 mb-8">
            <!-- Admin Charts Replay -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Overall Statistics</h3>
                    <div class="flex gap-2">
                        <button id="toggleAdminChart" class="text-blue-500 hover:text-blue-600 dark:text-blue-400">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="refreshStats" class="text-green-500 hover:text-green-600 dark:text-green-400">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="adminStatsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Applications -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Recent Applications</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Scholarship</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Applications will be populated here -->
                    </tbody>
                </table>
                <div id="applicationsEmpty" class="hidden p-8 text-center text-gray-500 dark:text-gray-400">No applications yet. Start applying to scholarships to see them here.</div>
            </div>
        </div>

        <!-- Progress Diagrams Section -->
        <div class="grid grid-cols-1 gap-6 mb-8">
            <!-- Diagrams Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Progress Diagrams</h3>
                    <div class="flex gap-2">
                        <button class="text-gray-500 hover:text-gray-600 dark:text-gray-400" id="toggleChart">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                        <button class="text-gray-500 hover:text-gray-600 dark:text-gray-400" id="downloadChart">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="h-64 flex items-center justify-center">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Available Scholarships -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Available Scholarships</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="scholarshipsList">
                <!-- Scholarships will be populated here -->
            </div>
        </div>
    </main>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Include the API service -->
    <script src="js/api.js"></script>
    <script src="js/include-user-layout.js"></script>
    <script src="js/logout-utility.js"></script>
    
    <script>
        // Check if user is logged in
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) {
            window.location.href = 'login.html';
        }

        // Update user name in navigation and welcome section
        async function loadCurrentUser() {
            try {
                const me = await window.api.get('/auth/me');
                const displayName = me.full_name || me.fullName || user.fullName || 'User';
                document.getElementById('userName').textContent = displayName;
                document.getElementById('welcomeName').textContent = displayName;
                // cache locally
                const cached = { ...(user || {}), fullName: displayName, email: me.email };
                localStorage.setItem('user', JSON.stringify(cached));
            } catch (e) {
                const displayName = user.fullName || 'User';
                document.getElementById('userName').textContent = displayName;
                document.getElementById('welcomeName').textContent = displayName;
            }
        }
        loadCurrentUser();

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.location.href = 'logout.html';
        });

        // Fetch and display applications
        async function loadDashboard() {
            try {
                // Fetch stats
                const stats = await window.api.get('/applications/stats');
                document.getElementById('activeApplications').textContent = stats.applications;
                document.getElementById('availableScholarships').textContent = stats.scholarships;

                // Fetch applications
                const applications = await window.api.get('/applications');
                const applicationsList = document.getElementById('applicationsList');
                const emptyState = document.getElementById('applicationsEmpty');
                applicationsList.innerHTML = '';

                if (!applications || applications.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }

                const statusBadge = (status) => {
                    const s = String(status || 'pending').toLowerCase();
                    const map = {
                        approved: 'bg-green-100 text-green-800',
                        rejected: 'bg-red-100 text-red-800',
                        under_review: 'bg-yellow-100 text-yellow-800',
                        waitlisted: 'bg-yellow-100 text-yellow-800',
                        pending: 'bg-gray-100 text-gray-800'
                    };
                    const cls = map[s] || map.pending;
                    return `<span class="inline-flex px-2 py-1 rounded-full text-xs font-medium ${cls}">${s.replace(/_/g,' ')}</span>`;
                };

                applications.forEach(app => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${app.scholarship_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            ${new Date(app.application_date).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge(app.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            <a href="#" data-app-id="${app.application_id}" class="view-details text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">View Details</a>
                        </td>
                    `;
                    applicationsList.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Fetch and display available scholarships
        async function loadScholarships() {
            try {
                const scholarships = await window.api.get('/scholarships');
                const scholarshipsList = document.getElementById('scholarshipsList');
                scholarshipsList.innerHTML = '';

                // Filter only open scholarships
                const openScholarships = scholarships.filter(scholarship => scholarship.status === 'active');

                openScholarships.forEach(scholarship => {
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-xl overflow-hidden shadow ring-1 ring-gray-100 dark:ring-0 hover:shadow-lg transition';
                    card.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${scholarship.name}</h4>
                                <span class="text-sm font-semibold px-2.5 py-1 rounded bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">$${scholarship.award_amount ? scholarship.award_amount.toLocaleString() : 'N/A'}</span>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300 mb-3">${scholarship.description.substring(0, 100)}...</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200">${scholarship.academic_level}</span>
                                <span class="text-xs px-2 py-1 rounded-full bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-200">${scholarship.scholarship_type}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500 dark:text-gray-400">Deadline: ${scholarship.application_deadline ? new Date(scholarship.application_deadline).toLocaleDateString() : 'Not set'}</span>
                                <a href="scholarship.html?id=${scholarship.id}"
                                    class="inline-flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-2 rounded-lg hover:from-emerald-600 hover:to-teal-600 transition">
                                    <i class="fas fa-paper-plane"></i>
                                    Apply Now
                                </a>
                            </div>
                        </div>
                    `;
                    scholarshipsList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading scholarships:', error);
            }
        }

        // Initialize charts
        let adminStatsChart;

        function initializeCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#F3F4F6' : '#374151';
            const gridColor = isDark ? 'rgba(243, 244, 246, 0.1)' : 'rgba(55, 65, 81, 0.1)';

            // Admin Stats Chart
            const adminCtx = document.getElementById('adminStatsChart').getContext('2d');
            adminStatsChart = new Chart(adminCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Applications', 'Total Scholarships'],
                    datasets: [{
                        label: 'Count',
                        data: [0, 0],
                        backgroundColor: [
                            '#4F46E5', // indigo
                            '#10B981', // green
                        ],
                        borderWidth: 1,
                        borderColor: isDark ? '#1F2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });

            // Chart toggle handlers
            document.getElementById('toggleAdminChart').addEventListener('click', () => {
                adminStatsChart.config.type = adminStatsChart.config.type === 'bar' ? 'line' : 'bar';
                adminStatsChart.update();
            });

            // Refresh stats handler
            document.getElementById('refreshStats').addEventListener('click', updateCharts);
        }

        // Update charts with real data
        async function updateCharts() {
            try {
                const stats = await window.api.get('/applications/stats');
                adminStatsChart.data.datasets[0].data = [
                    stats.applications,
                    stats.scholarships
                ];
                adminStatsChart.update();
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // Load initial data
        loadDashboard();
        loadScholarships();
        initializeCharts();
        updateCharts();
        initializeProgressDiagrams();

        // Initialize Progress Diagrams
        function initializeProgressDiagrams() {
            // Initialize progress chart
            const ctx = document.getElementById('progressChart').getContext('2d');
            const progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#10B981', // green
                            '#F59E0B', // yellow
                            '#EF4444'  // red
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
                            }
                        }
                    }
                }
            });

            // Load real data for progress chart
            async function updateProgressChart() {
                try {
                    const summary = await window.api.get('/applications/progress');
                    const approved = Number(summary.approved || 0);
                    const pending = Number(summary.pending || 0) + Number(summary.under_review || 0) + Number(summary.waitlisted || 0);
                    const rejected = Number(summary.rejected || 0);
                    progressChart.data.datasets[0].data = [approved, pending, rejected];
                    progressChart.update();
                } catch (e) {
                    console.error('Error loading progress summary:', e);
                }
            }

            updateProgressChart();

            // Toggle chart type
            document.getElementById('toggleChart').addEventListener('click', () => {
                progressChart.config.type = progressChart.config.type === 'doughnut' ? 'pie' : 'doughnut';
                progressChart.update();
            });

            // Download chart
            document.getElementById('downloadChart').addEventListener('click', () => {
                const link = document.createElement('a');
                link.download = 'progress-chart.png';
                link.href = document.getElementById('progressChart').toDataURL('image/png');
                link.click();
            });
        }

        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        // Initialize theme from localStorage or system preference
        function initializeTheme() {
          if (localStorage.getItem('color-theme')) {
            if (localStorage.getItem('color-theme') === 'dark') {
              document.documentElement.classList.add('dark');
              if (themeIcon) themeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
              document.documentElement.classList.remove('dark');
              if (themeIcon) themeIcon.classList.replace('fa-sun', 'fa-moon');
            }
          } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('color-theme', 'dark');
            if (themeIcon) themeIcon.classList.replace('fa-moon', 'fa-sun');
          }
        }
        
        // Toggle theme
        function toggleTheme() {
          if (themeIcon) {
            if (themeIcon.classList.contains('fa-moon')) {
              themeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
              themeIcon.classList.replace('fa-sun', 'fa-moon');
            }
          }
          
          if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('color-theme', 'light');
          } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('color-theme', 'dark');
          }
        }

        // Initialize theme on page load
        initializeTheme();

        // Add welcome message fadeout with immediate trigger option
        const welcomeSection = document.getElementById('welcomeSection');
        
        // Function to handle fadeout
        function fadeOutWelcome() {
            welcomeSection.classList.add('fade-out');
            welcomeSection.addEventListener('animationend', () => {
                welcomeSection.remove(); // Use remove() instead of display:none for better cleanup
            }, { once: true }); // Ensure event listener is removed after execution
        }

        // Start fadeout after a short delay
        const fadeOutTimeout = setTimeout(fadeOutWelcome, 800);

        // Allow manual dismiss by clicking
        welcomeSection.addEventListener('click', () => {
            clearTimeout(fadeOutTimeout);
            fadeOutWelcome();
        });

        // Add event listener if theme toggle exists
        if (themeToggle) {
          themeToggle.addEventListener('click', toggleTheme);
        }
        
        // Modal: Application Details
        (function initApplicationModal(){
            const modal = document.createElement('div');
            modal.id = 'applicationModal';
            modal.className = 'fixed inset-0 z-50 hidden';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/40" data-modal-close></div>
                <div class="absolute inset-0 flex items-center justify-center p-4">
                    <div class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <div class="flex items-center justify-between px-6 py-4 border-b dark:border-gray-700">
                            <h3 id="modalScholarshipTitle" class="text-lg font-semibold text-gray-900 dark:text-white">Application Details</h3>
                            <button class="text-gray-500 hover:text-gray-700 dark:text-gray-300" title="Close" data-modal-close>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Submitted on <span id="modalSubmittedDate">â€”</span></p>
                            <span id="modalStatusBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">â€”</span>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-md font-semibold text-gray-800 dark:text-white mb-2">Applicant</h4>
                                    <dl class="space-y-2">
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Full Name</dt><dd id="modalFullName" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Email</dt><dd id="modalEmail" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Phone</dt><dd id="modalPhone" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Academic Level</dt><dd id="modalAcademicLevel" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                    </dl>
                                </div>
                                <div>
                                    <h4 class="text-md font-semibold text-gray-800 dark:text-white mb-2">Scholarship</h4>
                                    <dl class="space-y-2">
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Name</dt><dd id="modalScholarshipName" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">Intended Major</dt><dd id="modalIntendedMajor" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                        <div class="flex justify-between gap-4"><dt class="text-gray-500">GPA</dt><dd id="modalGpa" class="text-gray-900 dark:text-gray-100 text-right">â€”</dd></div>
                                    </dl>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold text-gray-800 dark:text-white mb-2">Statement</h4>
                                <p id="modalMotivation" class="text-gray-700 dark:text-gray-200 whitespace-pre-line">â€”</p>
                            </div>
                        </div>
                        <div class="px-6 py-4 border-t dark:border-gray-700 flex justify-end gap-2">
                            <button class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100" data-modal-close>Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            function statusClasses(status) {
                const s = String(status || '').toLowerCase();
                if (s === 'approved') return 'bg-green-100 text-green-800';
                if (s === 'rejected') return 'bg-red-100 text-red-800';
                if (s === 'under_review' || s === 'waitlisted') return 'bg-yellow-100 text-yellow-800';
                return 'bg-gray-100 text-gray-800';
            }

            async function openApplicationModal(id) {
                try {
                    // Clear existing content to a loading state
                    document.getElementById('modalScholarshipTitle').textContent = 'Loading...';
                    document.getElementById('modalSubmittedDate').textContent = 'â€”';
                    const badge = document.getElementById('modalStatusBadge');
                    badge.textContent = 'â€”';
                    badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';

                    const app = await window.api.get(`/applications/${encodeURIComponent(id)}`);
                    document.getElementById('modalScholarshipTitle').textContent = app.scholarship_name || 'Application Details';
                    document.getElementById('modalSubmittedDate').textContent = new Date(app.application_date).toLocaleDateString();
                    badge.textContent = (app.status || 'pending').replace(/_/g, ' ');
                    badge.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClasses(app.status)}`;

                    document.getElementById('modalFullName').textContent = app.full_name || 'â€”';
                    document.getElementById('modalEmail').textContent = app.email_address || 'â€”';
                    document.getElementById('modalPhone').textContent = app.phone_number || 'â€”';
                    document.getElementById('modalAcademicLevel').textContent = app.academic_level || 'â€”';

                    document.getElementById('modalScholarshipName').textContent = app.scholarship_name || 'â€”';
                    document.getElementById('modalIntendedMajor').textContent = app.intended_major || 'â€”';
                    document.getElementById('modalGpa').textContent = app.gpa_academic_performance || 'â€”';
                    const statement = app.motivation_statement || app.financial_need_statement || '';
                    document.getElementById('modalMotivation').textContent = statement || 'No statement provided.';
                } catch (e) {
                    console.error('Failed to load application details:', e);
                }
                modal.classList.remove('hidden');
            }

            // Delegated click for View Details links
            document.addEventListener('click', (evt) => {
                const link = evt.target.closest('a.view-details[data-app-id]');
                if (link) {
                    evt.preventDefault();
                    const id = link.getAttribute('data-app-id');
                    if (id) openApplicationModal(id);
                }
                if (evt.target.matches('[data-modal-close]')) {
                    modal.classList.add('hidden');
                }
            });
            
            // ESC to close
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') modal.classList.add('hidden');
            });
        })();

        // Sidebar toggle
        (function initSidebar(){
            const sidebar = document.getElementById('userSidebar');
            const toggle = document.getElementById('sidebar-toggle');
            const main = document.querySelector('main');
            function open(){ sidebar.classList.remove('-translate-x-full'); }
            function close(){ sidebar.classList.add('-translate-x-full'); }
            if (toggle) {
                toggle.addEventListener('click', () => {
                    const isOpen = !sidebar.classList.contains('-translate-x-full');
                    if (isOpen) close(); else open();
                });
            }
            // Close when clicking outside on small screens
            document.addEventListener('click', (e) => {
                if (window.innerWidth >= 768) return; // only for mobile
                const insideSidebar = e.target.closest('#userSidebar');
                const clickedToggle = e.target.closest('#sidebar-toggle');
                if (!insideSidebar && !clickedToggle) close();
            });
        })();
    </script>
</body>
</html>