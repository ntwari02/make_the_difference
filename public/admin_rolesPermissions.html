<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roles & Permissions - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                500: '#3b82f6',
                600: '#2563eb',
              }
            }
          }
        }
      }
    </script>
    <script>
      (function() {
        try {
          var theme = localStorage.getItem('color-theme');
          if (
            theme === 'dark' ||
            (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
          ) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        } catch (e) {}
      })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/admin-layout.css">
    <link rel="stylesheet" href="css/admin-sidebar-fix.css">
    <script src="js/include-admin-header.js" defer></script>
    <script src="js/include-admin-sidebar.js" defer></script>
    <style>
        .sidebar {
            width: 280px;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-item-text {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-item-text {
            opacity: 0;
            display: none;
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 40;
            }

            .sidebar.mobile-open {
                left: 0;
            }
        }
    </style>
</head>
<body class="admin-layout bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div id="admin-sidebar-container"></div>
    <div id="admin-header-container" data-page-title="Roles & Permissions"></div>
    <main class="admin-main-content w-full bg-transparent dark:bg-transparent">
        <div class="admin-content-container">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                

                <!-- Users & Privileges Section -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Users & Privileges</h2>
                        <button id="refreshUsersPrivileges" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-sync mr-2"></i>
                            Refresh
                        </button>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow p-4">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Total Users</div>
                            <div id="sumTotalUsers" class="text-2xl font-bold">-</div>
                        </div>
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow p-4">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Admins</div>
                            <div id="sumAdmins" class="text-2xl font-bold">-</div>
                        </div>
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow p-4">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Super Admins</div>
                            <div id="sumSuperAdmins" class="text-2xl font-bold">-</div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-md rounded-lg overflow-hidden">
                        <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center justify-between">
                            <div class="relative">
                                <input id="usersPrivSearch" type="text" placeholder="Search users..." class="pl-10 pr-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-primary-500" />
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400" id="usersPrivCount"></div>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersPrivilegesTable" class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                        </table>
                        <div class="px-4 py-3 flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-gray-200 dark:border-gray-700">
                            <div id="usersPrivPageInfo" class="text-sm text-gray-600 dark:text-gray-300"></div>
                            <div class="flex items-center gap-2">
                                <button id="usersPrivPrev" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 disabled:opacity-50">Previous</button>
                                <button id="usersPrivNext" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 disabled:opacity-50">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Permissions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Permission Groups -->
                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-md rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">User Management</h3>
                            <div class="space-y-3" id="userPermissions">
                                <!-- Permission checkboxes will be dynamically added here -->
                            </div>
                        </div>

                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-md rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Scholarship Management</h3>
                            <div class="space-y-3" id="scholarshipPermissions">
                                <!-- Permission checkboxes will be dynamically added here -->
                            </div>
                        </div>

                        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-md rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">System Settings</h3>
                            <div class="space-y-3" id="systemPermissions">
                                <!-- Permission checkboxes will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Members Management -->
                <div class="mt-12">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Team Members</h2>
                        <button id="tmNewBtn" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded">New Member</button>
                    </div>
                    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow p-4">
                        <div id="tmList" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <script>


        // Sidebar Toggle (admin sidebar is injected asynchronously)
        const sidebar = document.getElementById('admin-sidebar') || document.getElementById('sidebar');
        const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
        const mainContent = document.querySelector('.admin-main-content');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');

        if (sidebarCollapseBtn) {
            sidebarCollapseBtn.addEventListener('click', () => {
                if (sidebar) sidebar.classList.toggle('collapsed');
                if (mainContent) {
                mainContent.classList.toggle('ml-[280px]');
                mainContent.classList.toggle('ml-[80px]');
                }
            });
        }
        if (mobileSidebarToggle) {
            mobileSidebarToggle.addEventListener('click', () => {
                if (sidebar) sidebar.classList.toggle('mobile-open');
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                const clickedInsideSidebar = sidebar ? sidebar.contains(e.target) : false;
                const clickedToggle = mobileSidebarToggle ? mobileSidebarToggle.contains(e.target) : false;
                if (!clickedInsideSidebar && !clickedToggle) {
                    if (sidebar) sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                if (sidebar) sidebar.classList.remove('mobile-open');
            }
        });

        // Roles and Permissions Management
        const rolesTableBody = document.getElementById('rolesTableBody');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const userPermissions = document.getElementById('userPermissions');
        const scholarshipPermissions = document.getElementById('scholarshipPermissions');
        const systemPermissions = document.getElementById('systemPermissions');
        // Users & Privileges
        const usersPrivilegesTable = document.getElementById('usersPrivilegesTable');
        const usersPrivSearch = document.getElementById('usersPrivSearch');
        const sumTotalUsers = document.getElementById('sumTotalUsers');
        const sumAdmins = document.getElementById('sumAdmins');
        const sumSuperAdmins = document.getElementById('sumSuperAdmins');
        const usersPrivCount = document.getElementById('usersPrivCount');
        const refreshUsersPrivileges = document.getElementById('refreshUsersPrivileges');
        let cachedUsersPriv = [];
        let usersPrivPagination = { page: 1, limit: 10, total: 0, pages: 1 };

        // Load roles and permissions
        async function loadRoles() {
            try {
                const response = await fetch('/api/roles/roles', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // Include authentication token if you have it in localStorage or similar
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    credentials: 'include' // Include cookies if using session-based auth
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // Redirect to login if unauthorized
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const roles = Array.isArray(data) ? data : [];
                
                if (roles.length === 0) {
                    rolesTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                                No roles found
                            </td>
                        </tr>
                    `;
                    return;
                }

                rolesTableBody.innerHTML = roles.map(role => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-200">${role.role_name}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${role.description || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${role.user_count || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editRole(${role.role_id})" class="text-primary-600 hover:text-primary-900 dark:text-primary-500 dark:hover:text-primary-400 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteRole(${role.role_id})" class="text-red-600 hover:text-red-900 dark:text-red-500 dark:hover:text-red-400">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading roles:', error);
                rolesTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-red-500">
                            Error loading roles. Please try again later.
                        </td>
                    </tr>
                `;
            }
        }

        async function loadPermissions() {
            try {
                const response = await fetch('/api/roles/permissions', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const permissions = data;

                // Helper function to populate permissions
                const populatePermissions = (containerId, permissionList) => {
                    if (!permissionList || !permissionList.length) {
                        document.getElementById(containerId).innerHTML = `
                            <div class="text-gray-500 dark:text-gray-400 text-sm">
                                No permissions available
                            </div>
                        `;
                        return;
                    }

                    document.getElementById(containerId).innerHTML = permissionList.map(perm => `
                        <div class="flex items-center">
                            <input type="checkbox" id="perm_${perm.permission_id}" 
                                   class="rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4"
                                   data-permission-id="${perm.permission_id}">
                            <label for="perm_${perm.permission_id}" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">
                                ${formatPermissionName(perm.permission_name)}
                            </label>
                        </div>
                    `).join('');
                };

                // Populate each permission category
                populatePermissions('userPermissions', permissions.user_management);
                populatePermissions('scholarshipPermissions', permissions.scholarship_management);
                populatePermissions('systemPermissions', permissions.system_settings);

            } catch (error) {
                console.error('Error loading permissions:', error);
                ['userPermissions', 'scholarshipPermissions', 'systemPermissions'].forEach(id => {
                    document.getElementById(id).innerHTML = `
                        <div class="text-red-500 text-sm">
                            Error loading permissions. Please try again later.
                        </div>
                    `;
                });
            }
        }

        // Load Users & Privileges summary/table
        async function loadUsersPrivileges(page = 1, limit = 10, search = '') {
            try {
                const url = new URL('/api/admin/users', window.location.origin);
                url.searchParams.set('page', page);
                url.searchParams.set('limit', limit);
                if (search) url.searchParams.set('search', search);
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const payload = await response.json();
                const data = payload && payload.data ? payload.data : payload;
                const users = data.users || [];
                cachedUsersPriv = users;
                // Summary
                const total = data.pagination ? (data.pagination.total ?? data.pagination.totalItems ?? users.length) : users.length;
                const admins = users.filter(u => (u.admin_level === 'super_admin') || (u.role === 'admin')).length;
                const supers = users.filter(u => u.admin_level === 'super_admin').length;
                if (sumTotalUsers) sumTotalUsers.textContent = total;
                if (sumAdmins) sumAdmins.textContent = admins;
                if (sumSuperAdmins) sumSuperAdmins.textContent = supers;
                if (usersPrivCount) usersPrivCount.textContent = `${users.length} user(s) on this page`;
                // Pagination state
                usersPrivPagination.page = data.pagination ? (data.pagination.page ?? data.pagination.currentPage ?? 1) : page;
                usersPrivPagination.limit = limit;
                usersPrivPagination.total = total;
                usersPrivPagination.pages = data.pagination ? (data.pagination.pages ?? Math.ceil(total / limit)) : Math.ceil(total / limit);
                // Render table
                renderUsersPrivilegesTable(users);
                renderUsersPrivPager();
            } catch (e) {
                console.error('Failed to load users & privileges', e);
                if (usersPrivilegesTable) usersPrivilegesTable.innerHTML = `
                    <tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Failed to load users</td></tr>
                `;
            }
        }

        function renderUsersPrivilegesTable(users) {
            if (!usersPrivilegesTable) return;
            usersPrivilegesTable.innerHTML = users.map(u => {
                const effectiveRole = (u.admin_level === 'super_admin') ? 'super_admin' : (u.role || 'user');
                const statusBadge = u.status === 'active'
                    ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                    : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100">${u.full_name || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">${u.email || ''}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${effectiveRole === 'super_admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'}">
                                ${effectiveRole}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusBadge}">${u.status || 'inactive'}</span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <button class="text-primary-600 dark:text-primary-400 mr-3" onclick="viewUserPrivileges(${u.id})"><i class="fas fa-eye"></i></button>
                            <button class="text-green-600 dark:text-green-400" onclick="editUserPrivileges(${u.id})"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderUsersPrivPager() {
            const pageInfo = document.getElementById('usersPrivPageInfo');
            const btnPrev = document.getElementById('usersPrivPrev');
            const btnNext = document.getElementById('usersPrivNext');
            if (!pageInfo || !btnPrev || !btnNext) return;
            const { page, limit, total, pages } = usersPrivPagination;
            const start = total === 0 ? 0 : (page - 1) * limit + 1;
            const end = Math.min(page * limit, total);
            pageInfo.textContent = `Showing ${start}-${end} of ${total}`;
            btnPrev.disabled = page <= 1;
            btnNext.disabled = page >= pages || pages === 0;
            btnPrev.onclick = () => {
                if (usersPrivPagination.page > 1) {
                    usersPrivPagination.page -= 1;
                    loadUsersPrivileges(usersPrivPagination.page, usersPrivPagination.limit, usersPrivSearch ? usersPrivSearch.value.trim() : '');
                }
            };
            btnNext.onclick = () => {
                if (usersPrivPagination.page < usersPrivPagination.pages) {
                    usersPrivPagination.page += 1;
                    loadUsersPrivileges(usersPrivPagination.page, usersPrivPagination.limit, usersPrivSearch ? usersPrivSearch.value.trim() : '');
                }
            };
        }

        // Modal to view/edit user privileges
        function openUserPrivModal() {
            const modal = document.getElementById('userPermsModal');
            if (modal) return;
            const html = `
                <div id="userPermsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white" id="userPermsTitle">User Privileges</h3>
                            <button onclick="closeUserPrivModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="flex items-center gap-3">
                                <div class="flex-1">
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Email</div>
                                    <div id="userPermsEmail" class="text-gray-800 dark:text-white"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500 dark:text-gray-400">Role</label>
                                    <select id="userPermsRole" class="ml-2 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                                        <option value="user">user</option>
                                        <option value="admin">admin</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500 dark:text-gray-400">Status</label>
                                    <select id="userPermsStatus" class="ml-2 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                                        <option value="active">active</option>
                                        <option value="inactive">inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="userPermsGrantAll" class="mr-2">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Grant all permissions (Super Admin)</span>
                                </label>
                            </div>
                            <div id="userPermsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                        </div>
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                            <button onclick="closeUserPrivModal()" class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300">Cancel</button>
                            <button id="userPermsSave" class="px-4 py-2 rounded bg-primary-600 hover:bg-primary-700 text-white">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeUserPrivModal() {
            const modal = document.getElementById('userPermsModal');
            if (modal) modal.remove();
        }

        async function viewUserPrivileges(userId) {
            await showUserPrivileges(userId, false);
        }

        async function editUserPrivileges(userId) {
            await showUserPrivileges(userId, true);
        }

        async function showUserPrivileges(userId, editable) {
            try {
                openUserPrivModal();
                const resp = await fetch(`/api/admin/users/${userId}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!resp.ok) throw new Error('Failed to fetch user');
                const payload = await resp.json();
                const user = payload.data || payload;
                const title = document.getElementById('userPermsTitle');
                const emailEl = document.getElementById('userPermsEmail');
                const roleEl = document.getElementById('userPermsRole');
                const statusEl = document.getElementById('userPermsStatus');
                const grantAllEl = document.getElementById('userPermsGrantAll');
                const saveBtn = document.getElementById('userPermsSave');
                if (title) title.textContent = `${user.full_name || ''} - Privileges`;
                if (emailEl) emailEl.textContent = user.email || '';
                if (roleEl) roleEl.value = user.role || 'user';
                if (statusEl) statusEl.value = user.status || 'active';
                await ensurePermCatalogLoaded();
                renderUserPermCheckboxes(user.permissions, grantAllEl && grantAllEl.checked);
                // Initialize grant all based on permissions
                if (grantAllEl) {
                    grantAllEl.checked = user.permissions === '*' || user.admin_level === 'super_admin';
                    grantAllEl.addEventListener('change', () => renderUserPermCheckboxes(user.permissions, grantAllEl.checked));
                }
                // Disable inputs if view-only
                [roleEl, statusEl, grantAllEl, saveBtn].forEach(el => { if (el) el.disabled = !editable; });
                const container = document.getElementById('userPermsContainer');
                if (container && !editable) {
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = true);
                }
                if (saveBtn && editable) {
                    saveBtn.onclick = async () => {
                        const newRole = (roleEl && roleEl.value) || user.role;
                        const newStatus = (statusEl && statusEl.value) || user.status;
                        const payload = { fullName: user.full_name, email: user.email, role: newRole, status: newStatus };
                        if (grantAllEl && grantAllEl.checked) {
                            payload.permissions = '*';
                        } else {
                            payload.permissions = collectUserPermSelections();
                        }
                        const upResp = await fetch(`/api/admin/users/${userId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: JSON.stringify(payload)
                        });
                        if (!upResp.ok) {
                            const err = await upResp.json().catch(() => ({}));
                            alert(err.message || 'Failed to update user');
                            return;
                        }
                        closeUserPrivModal();
                        loadUsersPrivileges();
                    };
                }
            } catch (e) {
                console.error('Failed to load user privileges', e);
                alert('Failed to load user privileges');
                closeUserPrivModal();
            }
        }

        // Load permission catalog once for the user modal
        let permCatalog = null;
        async function ensurePermCatalogLoaded() {
            if (permCatalog) return;
            const resp = await fetch('/api/roles/permissions', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
            permCatalog = await resp.json();
        }

        function renderUserPermCheckboxes(preselected = null, grantAll = false) {
            const container = document.getElementById('userPermsContainer');
            if (!container) return;
            container.innerHTML = '';
            const selected = new Set();
            if (preselected === '*') {
                grantAll = true;
            } else if (preselected && typeof preselected === 'object') {
                Object.keys(preselected).forEach(k => preselected[k] && selected.add(k));
            } else if (Array.isArray(preselected)) {
                preselected.forEach(k => selected.add(k));
            }
            Object.keys(permCatalog || {}).forEach(cat => {
                const group = document.createElement('div');
                group.className = 'border rounded-md p-3';
                const title = document.createElement('div');
                title.className = 'font-medium mb-2 text-gray-700 dark:text-gray-300';
                title.textContent = cat.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                group.appendChild(title);
                (permCatalog[cat] || []).forEach(p => {
                    const row = document.createElement('label');
                    row.className = 'flex items-center space-x-2 mb-2 text-sm text-gray-700 dark:text-gray-300';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    const key = p.permission_name || p.key || p.permission_id;
                    cb.dataset.permKey = key;
                    cb.checked = selected.has(key);
                    cb.disabled = grantAll;
                    row.appendChild(cb);
                    const span = document.createElement('span');
                    span.textContent = p.permission_name || p.name || key;
                    row.appendChild(span);
                    group.appendChild(row);
                });
                container.appendChild(group);
            });
        }

        function collectUserPermSelections() {
            const container = document.getElementById('userPermsContainer');
            if (!container) return [];
            const keys = [];
            container.querySelectorAll('input[type="checkbox"][data-perm-key]').forEach(cb => { if (cb.checked) keys.push(cb.dataset.permKey); });
            return keys;
        }

        // Function to close role modal
        window.closeRoleModal = function() {
            const modal = document.getElementById('roleModal');
            if (!modal) return;

            // Add exit animations
            modal.classList.remove('opacity-100');
            modal.querySelector('.modal-content').classList.add('translate-y-4');

            // Remove modal after animation
            setTimeout(() => {
                modal.remove();
            }, 300);
        }

        // Function to show role modal
        window.showRoleModal = function(role = null) {
            const modalHtml = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center opacity-0 transition-opacity duration-300" id="roleModal">
                    <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-hidden transform translate-y-4 transition-transform duration-300">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                                    ${role ? 'Edit Role' : 'Create New Role'}
                                </h2>
                                <button onclick="closeRoleModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <form id="roleForm" class="overflow-auto max-h-[calc(90vh-10rem)]">
                            <div class="p-6 space-y-6">
                                <!-- Basic Information -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Basic Information</h3>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role Name *</label>
                                        <input type="text" id="roleName" required
                                            class="w-full px-3 py-2 rounded-md border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            value="${role ? role.role_name : ''}"
                                            placeholder="Enter role name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                                        <textarea id="roleDescription" rows="3"
                                            class="w-full px-3 py-2 rounded-md border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            placeholder="Enter role description">${role ? role.description : ''}</textarea>
                                    </div>
                                </div>

                                <!-- Permissions -->
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Permissions</h3>
                                        <div class="flex items-center space-x-4">
                                            <button type="button" onclick="selectAllPermissions(true)" 
                                                class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 flex items-center">
                                                <i class="fas fa-check-square mr-1"></i> Select All
                                            </button>
                                            <button type="button" onclick="selectAllPermissions(false)"
                                                class="text-sm text-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 flex items-center">
                                                <i class="fas fa-square mr-1"></i> Deselect All
                                            </button>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <!-- User Management Permissions -->
                                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                                                <div class="flex items-center justify-between">
                                                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                                                        User Management
                                                    </h4>
                                                    <div class="flex items-center space-x-2">
                                                        <button type="button" onclick="selectCategoryPermissions('user', true)" 
                                                            class="text-xs text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300">
                                                            <i class="fas fa-check-square"></i>
                                                        </button>
                                                        <button type="button" onclick="selectCategoryPermissions('user', false)"
                                                            class="text-xs text-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                                            <i class="fas fa-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 space-y-3" id="userPermissionsModal">
                                            </div>
                                        </div>

                                        <!-- Scholarship Management Permissions -->
                                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                                                <div class="flex items-center justify-between">
                                                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                                                        Scholarship Management
                                                    </h4>
                                                    <div class="flex items-center space-x-2">
                                                        <button type="button" onclick="selectCategoryPermissions('scholarship', true)" 
                                                            class="text-xs text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300">
                                                            <i class="fas fa-check-square"></i>
                                                        </button>
                                                        <button type="button" onclick="selectCategoryPermissions('scholarship', false)"
                                                            class="text-xs text-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                                            <i class="fas fa-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 space-y-3" id="scholarshipPermissionsModal">
                                            </div>
                                        </div>

                                        <!-- System Settings Permissions -->
                                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                                                <div class="flex items-center justify-between">
                                                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                                                        System Settings
                                                    </h4>
                                                    <div class="flex items-center space-x-2">
                                                        <button type="button" onclick="selectCategoryPermissions('system', true)" 
                                                            class="text-xs text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300">
                                                            <i class="fas fa-check-square"></i>
                                                        </button>
                                                        <button type="button" onclick="selectCategoryPermissions('system', false)"
                                                            class="text-xs text-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                                            <i class="fas fa-square"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 space-y-3" id="systemPermissionsModal">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                                <button type="button" onclick="closeRoleModal()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                    Cancel
                                </button>
                                <button type="submit"
                                    class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    ${role ? 'Update Role' : 'Create Role'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('roleModal');
            const roleForm = document.getElementById('roleForm');

            // Load permissions into modal
            loadModalPermissions();

            // If editing, set the permissions after a short delay to ensure checkboxes are loaded
            if (role && role.permissions) {
                setTimeout(() => {
                    role.permissions.forEach(perm => {
                        const checkbox = document.querySelector(`input[data-permission-id="${perm.permission_id}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                }, 100);
            }

            // Show modal with animation
            requestAnimationFrame(() => {
                modal.classList.add('opacity-100');
                modal.querySelector('.modal-content').classList.remove('translate-y-4');
            });

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeRoleModal();
                }
            });

            // Handle form submission
            roleForm.onsubmit = (e) => handleRoleSubmit(e, role);
        }

        // Function to handle role form submission
        window.handleRoleSubmit = async function(e, role = null) {
            e.preventDefault();
            const roleName = document.getElementById('roleName').value.trim();
            const roleDescription = document.getElementById('roleDescription').value.trim();
            
            if (!roleName) {
                alert('Role name is required');
                return;
            }

            const selectedPermissions = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.dataset.permissionId));

            if (selectedPermissions.length === 0) {
                if (!confirm('Are you sure you want to create a role with no permissions?')) {
                    return;
                }
            }

            try {
                const url = role ? `/api/roles/roles/${encodeURIComponent(role.role_id)}` : '/api/roles/roles';
                const method = role ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        role_name: roleName,
                        description: roleDescription,
                        permissions: selectedPermissions
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save role');
                }

                closeRoleModal();
                await loadRoles();
                alert(role ? 'Role updated successfully!' : 'Role created successfully!');
            } catch (error) {
                console.error('Error saving role:', error);
                alert(error.message || 'Error saving role');
            }
        }

        // Role management actions removed

        // Role management actions removed

        // Function to load permissions into modal
        async function loadModalPermissions() {
            try {
                const response = await fetch('/api/roles/permissions');
                const permissions = await response.json();
                
                // Helper function to create permission HTML
                const createPermissionHTML = (perm, category) => `
                    <div class="permission-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-600/50 rounded-lg">
                        <label class="flex items-center w-full cursor-pointer">
                            <input type="checkbox" 
                                   class="permission-checkbox ${category}-permission form-checkbox h-5 w-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
                                   data-permission-id="${perm.permission_id}"
                                   data-category="${category}">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-700 dark:text-gray-200">
                                    ${formatPermissionName(perm.permission_name)}
                                </span>
                                <span class="block text-xs text-gray-500 dark:text-gray-400">
                                    ${perm.description || 'No description available'}
                                </span>
                            </span>
                        </label>
                    </div>
                `;

                // Populate permissions for each category
                if (permissions.user_management) {
                    document.getElementById('userPermissionsModal').innerHTML = 
                        permissions.user_management.map(perm => createPermissionHTML(perm, 'user')).join('');
                }

                if (permissions.scholarship_management) {
                    document.getElementById('scholarshipPermissionsModal').innerHTML = 
                        permissions.scholarship_management.map(perm => createPermissionHTML(perm, 'scholarship')).join('');
                }

                if (permissions.system_settings) {
                    document.getElementById('systemPermissionsModal').innerHTML = 
                        permissions.system_settings.map(perm => createPermissionHTML(perm, 'system')).join('');
                }

                // Add event listeners for checkbox changes
                document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const item = e.target.closest('.permission-item');
                        if (item) {
                            if (e.target.checked) {
                                item.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
                                item.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-600/50');
                            } else {
                                item.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                                item.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-600/50');
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading permissions:', error);
                alert('Error loading permissions');
            }
        }

        // Function to select/deselect all permissions in a category
        function selectCategoryPermissions(category, select) {
            document.querySelectorAll(`.${category}-permission`).forEach(checkbox => {
                checkbox.checked = select;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Function to select/deselect all permissions
        function selectAllPermissions(select) {
            document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                checkbox.checked = select;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Helper function to format permission names
        function formatPermissionName(name) {
            return name
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPermissions();
            loadUsersPrivileges();
            if (usersPrivSearch) {
                let t;
                usersPrivSearch.addEventListener('input', () => {
                    clearTimeout(t);
                    t = setTimeout(() => loadUsersPrivileges(1, 50, usersPrivSearch.value.trim()), 300);
                });
            }
            if (refreshUsersPrivileges) refreshUsersPrivileges.addEventListener('click', () => loadUsersPrivileges());

            // Team members init
            initTeamMembersAdmin();
        });
        // Role management UI removed

        // ---- Team Members Admin ----
        function initTeamMembersAdmin(){
            const list = document.getElementById('tmList');
            const newBtn = document.getElementById('tmNewBtn');
            if (!list || !newBtn) return;
            const norm = p => { if(!p) return ''; let s=String(p).replace(/\\/g,'/'); if(!s.startsWith('/')) s='/'+s; return s; };
            async function load(){
                try{
                    const res = await fetch('/api/team/all', { headers:{ 'Authorization': `Bearer ${localStorage.getItem('token')}` }});
                    const data = await res.json().catch(()=>({}));
                    const team = data.team || [];
                    list.innerHTML = team.map(m => `
                      <div class="py-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                          ${m.image_path?`<img src="${norm(m.image_path)}" class="w-10 h-10 rounded object-cover border">`:`<div class='w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-gray-400'><i class='fas fa-user'></i></div>`}
                          <div>
                            <div class="font-medium text-gray-900 dark:text-white">${m.name}</div>
                            <div class="text-sm text-gray-500">${m.title||''}</div>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <button class="px-2 py-1 text-blue-600" data-edit="${m.id}"><i class="fas fa-edit"></i></button>
                          <button class="px-2 py-1 text-red-600" data-del="${m.id}"><i class="fas fa-trash"></i></button>
                        </div>
                      </div>`).join('');
                    // Bind actions
                    list.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> openForm(b.dataset.edit)));
                    list.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> removeMember(b.dataset.del)));
                }catch{ list.innerHTML = '<div class="text-sm text-red-500">Failed to load team</div>'; }
            }
            async function removeMember(id){
                if (!confirm('Delete this member?')) return;
                const res = await fetch(`/api/team/${id}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${localStorage.getItem('token')}` }});
                if (!res.ok) return alert('Delete failed');
                load();
            }
            function openForm(id){
                const holder = document.createElement('div');
                holder.id = 'tmModal';
                holder.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                holder.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                  <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${id?'Edit':'Add'} Team Member</h3>
                    <button id="tmClose" class="text-gray-500"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="p-4 space-y-3 overflow-y-auto max-h-[65vh]">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div><label class="text-sm">Name</label><input id="tmName" class="w-full px-3 py-2 rounded border"></div>
                      <div><label class="text-sm">Title</label><input id="tmTitle" class="w-full px-3 py-2 rounded border"></div>
                    </div>
                    <div><label class="text-sm">Bio</label><textarea id="tmBio" rows="3" class="w-full px-3 py-2 rounded border"></textarea></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div><label class="text-sm">Email</label><input id="tmEmail" class="w-full px-3 py-2 rounded border"></div>
                      <div><label class="text-sm">Phone</label><input id="tmPhone" class="w-full px-3 py-2 rounded border"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div><label class="text-sm">LinkedIn</label><input id="tmLinkedin" class="w-full px-3 py-2 rounded border"></div>
                      <div><label class="text-sm">Twitter</label><input id="tmTwitter" class="w-full px-3 py-2 rounded border"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div><label class="text-sm">Display Order</label><input id="tmOrder" type="number" value="0" class="w-full px-3 py-2 rounded border"></div>
                      <div class="flex items-center gap-2"><input id="tmActive" type="checkbox" checked><label for="tmActive">Active</label></div>
                    </div>
                    <div>
                      <label class="text-sm">Photo</label>
                      <input id="tmPhoto" type="file" accept="image/*" class="sr-only">
                      <div id="tmDrop" class="p-4 border-2 border-dashed rounded text-gray-500 cursor-pointer">Drag & drop or click to select</div>
                      <div class="mt-2"><img id="tmPreview" class="hidden w-24 h-24 rounded object-cover border"></div>
                    </div>
                  </div>
                  <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                    <button id="tmCancel" class="px-4 py-2 rounded border">Cancel</button>
                    <button id="tmSave" class="px-4 py-2 rounded bg-primary-600 text-white">Save</button>
                  </div>
                </div>`;
                document.body.appendChild(holder);
                const close = ()=> holder.remove();
                holder.querySelector('#tmClose').onclick = close;
                holder.querySelector('#tmCancel').onclick = close;
                // drag-drop
                const fileEl = holder.querySelector('#tmPhoto');
                const dropEl = holder.querySelector('#tmDrop');
                const preview = holder.querySelector('#tmPreview');
                const setPrev = f=>{ if(!f||!f.type.startsWith('image/')){ preview.classList.add('hidden'); return;} const u=URL.createObjectURL(f); preview.src=u; preview.classList.remove('hidden'); };
                dropEl.addEventListener('click', ()=> fileEl.click());
                dropEl.addEventListener('dragover', e=>{ e.preventDefault(); dropEl.classList.add('ring','ring-blue-400'); });
                dropEl.addEventListener('dragleave', ()=> dropEl.classList.remove('ring','ring-blue-400'));
                dropEl.addEventListener('drop', e=>{ e.preventDefault(); dropEl.classList.remove('ring','ring-blue-400'); const f=e.dataTransfer.files[0]; if(!f) return; const dt=new DataTransfer(); dt.items.add(f); fileEl.files=dt.files; setPrev(f); });
                fileEl.addEventListener('change', ()=> setPrev(fileEl.files[0]));
                // load existing
                if (id){ fetch(`/api/team/all`, { headers:{ 'Authorization': `Bearer ${localStorage.getItem('token')}` }}).then(r=>r.json()).then(d=>{
                    const m = (d.team||[]).find(x=> String(x.id)===String(id)); if (!m) return;
                    holder.querySelector('#tmName').value = m.name||'';
                    holder.querySelector('#tmTitle').value = m.title||'';
                    holder.querySelector('#tmBio').value = m.bio||'';
                    holder.querySelector('#tmEmail').value = m.email||'';
                    holder.querySelector('#tmPhone').value = m.phone||'';
                    holder.querySelector('#tmLinkedin').value = m.linkedin||'';
                    holder.querySelector('#tmTwitter').value = m.twitter||'';
                    holder.querySelector('#tmOrder').value = m.display_order||0;
                    holder.querySelector('#tmActive').checked = !!m.is_active;
                    if (m.image_path){ preview.src = norm(m.image_path); preview.classList.remove('hidden'); }
                }); }
                // save
                holder.querySelector('#tmSave').onclick = async ()=>{
                    const payload = {
                        name: holder.querySelector('#tmName').value.trim(),
                        title: holder.querySelector('#tmTitle').value.trim(),
                        bio: holder.querySelector('#tmBio').value.trim(),
                        email: holder.querySelector('#tmEmail').value.trim(),
                        phone: holder.querySelector('#tmPhone').value.trim(),
                        linkedin: holder.querySelector('#tmLinkedin').value.trim(),
                        twitter: holder.querySelector('#tmTwitter').value.trim(),
                        display_order: parseInt(holder.querySelector('#tmOrder').value||0,10),
                        is_active: holder.querySelector('#tmActive').checked?1:0
                    };
                    if (!payload.name) return alert('Name is required');
                    const token = localStorage.getItem('token');
                    if (!id){
                        const res = await fetch('/api/team', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                        if (!res.ok) return alert('Save failed');
                        const data = await res.json().catch(()=>({}));
                        const newId = data.member && data.member.id;
                        const file = fileEl.files && fileEl.files[0];
                        if (newId && file){ const fd=new FormData(); fd.append('photo', file); await fetch(`/api/team/${newId}/photo`, { method:'POST', headers:{ 'Authorization': `Bearer ${token}` }, body: fd }); }
                    } else {
                        const res = await fetch(`/api/team/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                        if (!res.ok) return alert('Update failed');
                        const file = fileEl.files && fileEl.files[0];
                        if (file){ const fd=new FormData(); fd.append('photo', file); await fetch(`/api/team/${id}/photo`, { method:'POST', headers:{ 'Authorization': `Bearer ${token}` }, body: fd }); }
                    }
                    close(); load();
                };
            }
            newBtn.addEventListener('click', ()=> openForm(null));
            load();
        }
    </script>
</body>
</html> 
