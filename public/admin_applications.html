<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applications Management - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3b82f6', // blue-500
                            600: '#2563eb', // blue-600
                        },
                        success: {
                            500: '#10b981', // emerald-500
                            600: '#059669', // emerald-600
                        },
                        warning: {
                            500: '#f59e0b', // amber-500
                            600: '#d97706', // amber-600
                        },
                        danger: {
                            500: '#ef4444', // red-500
                            600: '#dc2626', // red-600
                        },
                        info: {
                            400: '#60a5fa', // blue-400
                            600: '#2563eb', // blue-600
                            900: '#1e3a8a', // blue-900
                        }
                    }
                }
            }
        }
    </script>
    <script>
      (function() {
        try {
          var theme = localStorage.getItem('color-theme');
          if (
            theme === 'dark' ||
            (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
          ) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        } catch (e) {}
      })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/admin-layout.css">
    <script src="js/include-admin-sidebar.js" defer></script>
    <script src="js/include-admin-header.js" defer></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --table-header: #f9fafb;
            --table-border: #e5e7eb;
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --input-bg: #1f2937;
            --input-border: #374151;
            --table-header: #1f2937;
            --table-border: #374151;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Main content styles */
        .main-content {
            padding-top: 4rem;
            min-height: 100vh;
            background-color: var(--bg-primary);
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .status-badge.approved {
            background-color: rgba(16, 185, 129, 0.2);
            color: #059669;
        }

        .status-badge.rejected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .dark .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .dark .status-badge.approved {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .dark .status-badge.rejected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-badge.under-review {
            background-color: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .dark .status-badge.under-review {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-badge.waitlisted {
            background-color: rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }

        .dark .status-badge.waitlisted {
            background-color: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid var(--text-secondary);
            border-radius: 50%;
            border-top-color: var(--text-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0 !important;
                padding: 4rem 1rem 1rem 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0 !important;
                padding: 4rem 1rem 1rem 1rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Application details card */
        .application-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .application-card h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .application-card p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Document preview */
        .document-preview {
            border: 1px dashed var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            cursor: pointer;
        }

        .document-preview:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
            max-width: 24rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .notification.success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #059669;
            border: 1px solid #059669;
        }

        .notification.error {
            background-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="admin-layout bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Admin Sidebar Container -->
    <div id="admin-sidebar-container"></div>

    <!-- Navigation Bar -->
    <div id="admin-header-container" data-page-title="Applications">
        <span id="adminName"></span>
    </div>

    <!-- Main Content -->
    <main class="admin-main-content w-full">
        <div class="admin-content-container">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold" style="color: var(--text-primary);">Applications Management</h2>
                        <p class="text-gray-600 dark:text-gray-400">Manage all scholarship applications</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <button id="createApplicationBtn" 
                            class="px-4 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors duration-200">
                            <i class="fas fa-plus mr-2"></i>Create Application
                        </button>
                        <div class="relative w-full">
                            <input type="text" id="searchInput" placeholder="Search applications..." 
                                class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 
                                bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 
                                focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Applications Table -->
                <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Applicant
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        University
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Country
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Applied Date
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTable" class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Applications will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingIndicator" class="p-4 text-center hidden">
                        <div class="loading-spinner inline-block"></div>
                        <span class="ml-2 text-gray-600 dark:text-gray-400">Loading applications...</span>
                    </div>
                    <div id="noApplications" class="p-8 text-center text-gray-500 dark:text-gray-400 hidden">
                        No applications found matching your criteria.
                    </div>
                    <div id="fetchError" class="p-8 text-center text-red-600 dark:text-red-400 hidden">
                        <span id="fetchErrorMessage"></span>
                        <br>
                        <button id="retryFetchBtn" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600">Retry</button>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Showing <span id="startRange">1</span> to <span id="endRange">10</span> of <span id="totalApplications">0</span> applications
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPage" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                            Previous
                        </button>
                        <button id="nextPage" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Application Details Modal -->
    <div id="applicationModal" class="modal-overlay">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">Application Details</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="applicationDetails">
                <!-- Application details will be loaded here -->
            </div>
            
            <div id="applicationActions" class="flex justify-end space-x-3 mt-6">
                <button id="closeBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Create Application Modal -->
    <div id="createApplicationModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Create New Application</h2>
                <button id="closeCreateModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="adminScholarshipForm" class="max-w-3xl mx-auto bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white p-8 rounded-lg shadow-lg border-l-4 border-primary-500" enctype="multipart/form-data">
                <input type="hidden" name="scholarship_id" id="scholarship_id" value="">
                <!-- Step 1: Personal Information -->
                <div class="form-step" id="step-1">
                    <div class="mb-6 flex flex-col items-center">
                        <label for="profilePicture" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Profile Picture</label>
                        <div id="profileUploadArea" class="relative flex flex-col items-center justify-center w-32 h-32 rounded-full border-2 border-dashed border-primary-500 dark:border-primary-400 bg-gray-100 dark:bg-dark-900 cursor-pointer transition hover:bg-primary-50 dark:hover:bg-primary-900/20 mb-2">
                            <img id="profilePreview" class="absolute w-32 h-32 rounded-full object-cover hidden z-10" alt="Profile Preview">
                            <div id="profilePlaceholder" class="flex flex-col items-center justify-center h-full w-full z-0">
                                <i class="fas fa-user-circle text-6xl text-gray-300 dark:text-white"></i>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Drag & drop or click</span>
                            </div>
                            <input type="file" id="profilePicture" name="profile_picture_url" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" required>
                        </div>
                        <button type="button" id="profileUploadBtn" class="mt-2 px-4 py-2 bg-primary-500 text-white rounded shadow hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500">Choose Photo</button>
                        <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Max size: 2MB. JPG, PNG, or GIF.</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="fullName" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Full Name</label>
                            <input type="text" id="fullName" name="full_name" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. Jane Doe" required>
                        </div>
                        <div>
                            <label for="emailAddress" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Email Address</label>
                            <input type="email" id="emailAddress" name="email_address" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. jane@email.com" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="dob" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Date of Birth</label>
                            <input type="date" id="dob" name="date_of_birth" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                        </div>
                        <div>
                            <label for="gender" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Gender</label>
                            <select id="gender" name="gender" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select gender</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="phone" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Phone Number</label>
                            <input type="tel" id="phone" name="phone_number" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. +250 123 456 789" required>
                        </div>
                        <div>
                            <label for="address" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Address</label>
                            <input type="text" id="address" name="address" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. 123 Main St, Kigali" required>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" class="next-step bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Next</button>
                    </div>
                </div>
                <!-- Step 2: Academic Information -->
                <div class="form-step hidden" id="step-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="preferredUniversity" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Preferred University</label>
                            <select id="preferredUniversity" name="preferred_university" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select a university</option>
                            </select>
                        </div>
                        <div>
                            <label for="country" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Country</label>
                            <select id="countryFilter" name="country" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select a country</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="academicLevel" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Academic Level</label>
                            <select id="academicLevel" name="academic_level" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select level</option>
                                <option value="undergraduate">Undergraduate</option>
                                <option value="graduate">Graduate</option>
                                <option value="phd">PhD</option>
                            </select>
                        </div>
                        <div>
                            <label for="intendedMajor" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Intended Major/Field of Study</label>
                            <input type="text" id="intendedMajor" name="intended_major" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. Computer Science">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="gpa" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">GPA / Academic Performance</label>
                            <input type="text" id="gpaAcademicPerformance" name="gpa_academic_performance" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. 3.8/4.0">
                        </div>
                        <div>
                            <label for="documents" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Upload Documents</label>
                            <input type="file" id="documents" name="uploaded_documents_json" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" multiple>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="extracurriculars" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Extracurricular Activities</label>
                        <textarea id="extracurricularActivities" name="extracurricular_activities" rows="2" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="List your activities, clubs, sports, etc."></textarea>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" class="prev-step bg-gray-300 text-gray-700 px-8 py-3 rounded font-semibold hover:bg-gray-400 transition-all duration-300">Back</button>
                        <button type="button" class="next-step bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Next</button>
                    </div>
                </div>
                <!-- Step 3: Additional Information -->
                <div class="form-step hidden" id="step-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="parentName" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian Name</label>
                            <input type="text" id="parentGuardianName" name="parent_guardian_name" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. John Doe">
                        </div>
                        <div>
                            <label for="parentContact" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian Contact</label>
                            <input type="text" id="parentGuardianContact" name="parent_guardian_contact" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. +250 987 654 321">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="financialNeed" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Financial Need Statement</label>
                        <textarea id="financialNeedStatement" name="financial_need_statement" rows="3" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="Describe your financial situation and why you need this scholarship."></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="referral" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">How did you hear about this scholarship?</label>
                        <input type="text" id="howHeardAbout" name="how_heard_about" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. School, Social Media, Friend">
                    </div>
                    <div class="mb-6">
                        <label for="message" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Why Are You Applying?</label>
                        <textarea id="motivationStatement" name="motivation_statement" rows="4" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="Briefly explain your motivation..."></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="terms_agreed" required>
                            <span class="ml-2 text-gray-700 dark:text-gray-300">I agree to the terms and conditions</span>
                        </label>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" class="prev-step bg-gray-300 text-gray-700 px-8 py-3 rounded font-semibold hover:bg-gray-400 transition-all duration-300">Back</button>
                        <button type="submit" class="bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Submit Application</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Update Application Status</h2>
                <button id="closeStatusModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="statusUpdateForm" class="space-y-4">
                <input type="hidden" id="statusApplicationId" name="applicationId">
                
                <div>
                    <label for="statusSelect" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Application Status</label>
                    <select id="statusSelect" name="status" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" required>
                        <option value="pending">Pending</option>
                        <option value="under_review">Under Review</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="waitlisted">Waitlisted</option>
                    </select>
                </div>
                
                <div>
                    <label for="reviewerNotes" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Reviewer Notes (Optional)</label>
                    <textarea id="reviewerNotes" name="reviewer_notes" rows="4" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="Add any notes about this application..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelStatusUpdate" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600">
                        Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div id="sendMessageModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Send Message to Applicant</h2>
                <button id="closeMessageModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="sendMessageForm" class="space-y-4">
                <input type="hidden" id="messageApplicationId" name="applicationId">
                <input type="hidden" id="messageUserEmail" name="userEmail">
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Applicant</label>
                    <div id="messageApplicantInfo" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                        <!-- Applicant info will be populated here -->
                    </div>
                </div>
                
                <div>
                    <label for="messageTitle" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Message Title</label>
                    <input type="text" id="messageTitle" name="title" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="e.g., Application Update" required>
                </div>
                
                <div>
                    <label for="messageContent" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Message Content</label>
                    <textarea id="messageContent" name="message" rows="6" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="Type your message here..." required></textarea>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="setMessageTemplate('approved')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 dark:bg-green-900 dark:text-green-300">
                        Application Approved
                    </button>
                    <button type="button" onclick="setMessageTemplate('rejected')" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-300">
                        Application Rejected
                    </button>
                    <button type="button" onclick="setMessageTemplate('under_review')" class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-300">
                        Under Review
                    </button>
                    <button type="button" onclick="setMessageTemplate('waitlisted')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300">
                        Waitlisted
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelMessage" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600">
                        Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // State management
        let applications = [];
        let currentPage = 1;
        const applicationsPerPage = 10;
        let currentApplicationId = null;
        let availableScholarships = [];
        let filteredApplications = [];
        let currentStepIndex = 0;

        // CRUD for admin_applications_simple
        let simpleApplications = [];

        // Helper function to convert snake_case to camelCase for application objects
        function toCamelCase(obj) {
            if (!obj) return obj;
            const map = {
                application_id: 'applicationId',
                full_name: 'fullName',
                email_address: 'emailAddress',
                profile_picture_url: 'profilePictureUrl',
                preferred_university: 'preferredUniversity',
                application_date: 'applicationDate',
                phone_number: 'phoneNumber',
                date_of_birth: 'dateOfBirth',
                uploaded_documents_json: 'uploadedDocumentsJson',
                academic_level: 'academicLevel',
                intended_major: 'intendedMajor',
                gpa_academic_performance: 'gpaAcademicPerformance',
                extracurricular_activities: 'extracurricularActivities',
                parent_guardian_name: 'parentGuardianName',
                parent_guardian_contact: 'parentGuardianContact',
                financial_need_statement: 'financialNeedStatement',
                how_heard_about: 'howHeardAbout',
                motivation_statement: 'motivationStatement',
                reviewer_notes: 'reviewerNotes',
                terms_agreed: 'termsAgreed'
            };
            const newObj = {};
            for (const key in obj) {
                newObj[map[key] || key] = obj[key];
            }
            return newObj;
        }

        function mapApplicationsToCamelCase(apps) {
            return apps.map(toCamelCase);
        }
        // DOM Elements
        const applicationsTable = document.getElementById('applicationsTable');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noApplications = document.getElementById('noApplications');
        const searchInput = document.getElementById('searchInput');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const startRange = document.getElementById('startRange');
        const endRange = document.getElementById('endRange');
        const totalApplications = document.getElementById('totalApplications');
        const applicationModal = document.getElementById('applicationModal');
        const applicationDetails = document.getElementById('applicationDetails');
        const closeBtn = document.getElementById('closeBtn');
        const closeModalBtn = document.getElementById('closeModal');
        const createApplicationBtn = document.getElementById('createApplicationBtn');
        const createApplicationModal = document.getElementById('createApplicationModal');
        const adminScholarshipForm = document.getElementById('adminScholarshipForm');
        const profilePreview = document.getElementById('profilePreview');
        const profilePlaceholder = document.getElementById('profilePlaceholder');
        const profilePictureInput = document.getElementById('profilePicture');
        const profileUploadBtn = document.getElementById('profileUploadBtn');
        const countryFilterInput = document.getElementById('countryFilter');
        
        const defaultAvatar = 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg>';
        
        // --- Country List ---
        const countries = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];
        
        // Make steps available everywhere
        const steps = Array.from(document.querySelectorAll('#adminScholarshipForm .form-step'));
        
        function showStep(index) {
            steps.forEach((step, i) => step.classList.toggle('hidden', i !== index));
            const firstInput = steps[index].querySelector('input, select, textarea');
            if (firstInput) firstInput.focus();
        }

        function populateCountries() {
            const countrySelect = document.getElementById('countryFilter');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        function goToNextStep() {
            const currentStep = steps[currentStepIndex];
            const inputs = Array.from(currentStep.querySelectorAll('input[required], select[required], textarea[required]'));

            if (inputs.every(input => input.checkValidity())) {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                showStep(currentStepIndex);
                }
            } else {
                inputs.find(input => !input.checkValidity()).reportValidity();
            }
        }

        function goToPrevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                showStep(currentStepIndex);
            }
        }

        function setupMultiStepNavigation() {
            document.querySelectorAll('#adminScholarshipForm .next-step').forEach(btn => btn.addEventListener('click', goToNextStep));
            document.querySelectorAll('#adminScholarshipForm .prev-step').forEach(btn => btn.addEventListener('click', goToPrevStep));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('adminName').textContent = user.fullName || 'Admin';
            
            setupEventListeners();
            loadApplications();
            populateCountries();
        });

        function setupEventListeners() {
            if (searchInput) searchInput.addEventListener('input', filterApplications);
            if (prevPageBtn) prevPageBtn.addEventListener('click', () => changePage(-1));
            if (nextPageBtn) nextPageBtn.addEventListener('click', () => changePage(1));
            if (closeBtn) closeBtn.addEventListener('click', hideModal);
            if (closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
            if (document.getElementById('logoutBtn')) {
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                });
            }
            if (createApplicationBtn) {
                createApplicationBtn.addEventListener('click', async () => {
                    adminScholarshipForm.reset();
                    adminScholarshipForm.dataset.applicationId = '';
                    document.querySelector('#createApplicationModal h2').textContent = 'Create New Application';
                    adminScholarshipForm.querySelector('button[type="submit"]').textContent = 'Submit Application';
                    profilePictureInput.required = true;
                    await loadScholarshipsAndPopulateSelects();
                    showCreateModal();
                });
            }
            if (document.getElementById('closeCreateModal')) document.getElementById('closeCreateModal').addEventListener('click', hideCreateModal);
            if (adminScholarshipForm) adminScholarshipForm.addEventListener('submit', handleApplicationSubmit);
            
            // Status modal event listeners
            const statusUpdateForm = document.getElementById('statusUpdateForm');
            const closeStatusModal = document.getElementById('closeStatusModal');
            const cancelStatusUpdate = document.getElementById('cancelStatusUpdate');
            const statusUpdateModal = document.getElementById('statusUpdateModal');
            
            if (statusUpdateForm) {
                statusUpdateForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const applicationId = document.getElementById('statusApplicationId').value;
                    const status = document.getElementById('statusSelect').value;
                    const reviewerNotes = document.getElementById('reviewerNotes').value;

                    try {
                        const response = await fetch(`/api/admin/applications/${applicationId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                status: status,
                                reviewer_notes: reviewerNotes
                            })
                        });

                        const result = await handleApiResponse(response);
                        if (result) {
                            showNotification('Application status updated successfully', 'success');
                            statusUpdateModal.classList.remove('show');
                            await loadApplications(); // Refresh the applications list
                        }
                    } catch (error) {
                        console.error('Error updating application status:', error);
                        showNotification('Failed to update application status', 'error');
                    }
                });
            }
            
            if (closeStatusModal) {
                closeStatusModal.addEventListener('click', function() {
                    statusUpdateModal.classList.remove('show');
                });
            }
            
            if (cancelStatusUpdate) {
                cancelStatusUpdate.addEventListener('click', function() {
                    statusUpdateModal.classList.remove('show');
                });
            }
            
            if (statusUpdateModal) {
                statusUpdateModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            }
            
            // Message modal event listeners
            const sendMessageForm = document.getElementById('sendMessageForm');
            const closeMessageModal = document.getElementById('closeMessageModal');
            const cancelMessage = document.getElementById('cancelMessage');
            const sendMessageModal = document.getElementById('sendMessageModal');
            
            if (sendMessageForm) {
                sendMessageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const applicationId = document.getElementById('messageApplicationId').value;
                    const userEmail = document.getElementById('messageUserEmail').value;
                    const title = document.getElementById('messageTitle').value;
                    const message = document.getElementById('messageContent').value;

                    try {
                        const response = await fetch('/api/notifications', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                email: userEmail,
                                title: title,
                                message: message
                            })
                        });

                        const result = await handleApiResponse(response);
                        if (result) {
                            const message = result.userFound 
                                ? 'Message sent successfully to registered user!' 
                                : 'Message sent successfully! (Notification created for applicant)';
                            showNotification(message, 'success');
                            sendMessageModal.classList.remove('show');
                        }
                    } catch (error) {
                        console.error('Error sending message:', error);
                        showNotification('Failed to send message: ' + (error.message || 'Unknown error'), 'error');
                    }
                });
            }
            
            if (closeMessageModal) {
                closeMessageModal.addEventListener('click', function() {
                    sendMessageModal.classList.remove('show');
                });
            }
            
            if (cancelMessage) {
                cancelMessage.addEventListener('click', function() {
                    sendMessageModal.classList.remove('show');
                });
            }
            
            if (sendMessageModal) {
                sendMessageModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            }
            
            setupMultiStepNavigation();
        }

        async function loadApplications() {
            try {
                showLoading(true);
                hideFetchError();
                const response = await fetch('/api/admin/applications', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await handleApiResponse(response);
                if (!Array.isArray(result)) {
                    console.warn('Applications API did not return an array:', result);
                    applications = [];
                } else {
                    applications = mapApplicationsToCamelCase(result);
                }
                filterApplications();
            } catch (error) {
                console.error('Error loading applications:', error);
                showFetchError('Unable to load applications. Please try again later.', loadApplications);
            } finally {
                showLoading(false);
            }
        }

        function filterApplications() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredApplications = applications.filter(app => 
                Object.values(app).some(val => 
                    String(val).toLowerCase().includes(searchTerm)
                )
            );
            currentPage = 1;
            updateApplicationsTable();
            updatePagination();
        }

        function updateApplicationsTable() {
            const startIndex = (currentPage - 1) * applicationsPerPage;
            const applicationsToDisplay = filteredApplications.slice(startIndex, startIndex + applicationsPerPage);
            
            noApplications.classList.toggle('hidden', filteredApplications.length > 0);

            const tableHtml = applicationsToDisplay.map(app => {
                const profileImgSrc = app.profilePictureUrl ? `/${app.profilePictureUrl}` : defaultAvatar;
                const university = app.preferredUniversity || 'N/A';
                const country = app.country || 'N/A';
                const appDate = app.applicationDate ? new Date(app.applicationDate).toLocaleDateString() : 'N/A';

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">${app.fullName}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${app.emailAddress}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">${university}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${country}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${getStatusClass(app.status || 'pending')}">${getStatusText(app.status || 'pending')}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            ${appDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewApplication(${app.applicationId})" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 mr-3"><i class="fas fa-eye"></i><span class="hidden md:inline"> View</span></button>
                            <button onclick="updateApplicationStatus(${app.applicationId})" class="text-warning-600 hover:text-warning-900 dark:text-warning-400 dark:hover:text-warning-300 mr-3"><i class="fas fa-edit"></i><span class="hidden md:inline"> Status</span></button>
                            <button onclick="sendMessageToUser(${app.applicationId}, '${app.emailAddress}', '${app.fullName}')" class="text-info-600 hover:text-info-900 dark:text-info-400 dark:hover:text-info-300 mr-3"><i class="fas fa-envelope"></i><span class="hidden md:inline"> Message</span></button>
                            <button onclick="deleteApplication(${app.applicationId})" class="text-danger-600 hover:text-danger-900 dark:text-danger-400 dark:hover:text-danger-300"><i class="fas fa-trash"></i><span class="hidden md:inline"> Delete</span></button>
                        </td>
                    </tr>
                `;
            }).join('');

            applicationsTable.innerHTML = tableHtml;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'pending';
                case 'under_review': return 'under-review';
                case 'approved': return 'approved';
                case 'rejected': return 'rejected';
                case 'waitlisted': return 'waitlisted';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'under_review': return 'Under Review';
                case 'approved': return 'Approved';
                case 'rejected': return 'Rejected';
                case 'waitlisted': return 'Waitlisted';
                default: return 'Pending';
            }
        }

        function updatePagination() {
            const total = filteredApplications.length;
            const totalPages = Math.ceil(total / applicationsPerPage);
            const startItem = total === 0 ? 0 : (currentPage - 1) * applicationsPerPage + 1;
            const endItem = Math.min(currentPage * applicationsPerPage, total);

            startRange.textContent = startItem;
            endRange.textContent = endItem;
            totalApplications.textContent = total;

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            prevPageBtn.classList.toggle('opacity-50', prevPageBtn.disabled);
            nextPageBtn.classList.toggle('opacity-50', nextPageBtn.disabled);
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(filteredApplications.length / applicationsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateApplicationsTable();
                updatePagination();
            }
        }

        async function viewApplication(applicationId) {
            try {
                showLoading(true);
                const response = await fetch(`/api/admin/applications/${applicationId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await handleApiResponse(response);
                if (!result) return;
                
                // Convert to camelCase for consistent field access
                const app = toCamelCase(result);
                
                let documentsHtml = 'No documents uploaded';
                if (app.uploadedDocumentsJson) {
                    try {
                        const docs = JSON.parse(app.uploadedDocumentsJson);
                        if (Array.isArray(docs) && docs.length > 0) {
                            documentsHtml = docs.map(doc => `<a href="/${doc}" target="_blank" class="underline text-primary-600">${doc.split('/').pop()}</a>`).join('<br>');
                        }
                    } catch (e) { console.error("Error parsing documents JSON", e); }
                }

                applicationDetails.innerHTML = `
                    <div class="space-y-4">
                        <div class="application-card flex flex-col items-center text-center">
                            <div class="relative w-32 h-32 mx-auto mb-3 group">
                                <img id="modalProfileImg" src="${app.profilePictureUrl ? '/' + app.profilePictureUrl : ''}" alt="Profile" class="w-32 h-32 rounded-full object-cover border-4 border-primary-500 shadow bg-gray-100 group-hover:scale-105 transition-transform duration-200" onerror="this.style.display='none';document.getElementById('modalProfileFallback').style.display='flex';">
                                <div id="modalProfileFallback" style="display:none;" class="absolute inset-0 flex items-center justify-center rounded-full bg-primary-100 text-primary-600 text-4xl font-bold select-none">
                                    ${app.fullName ? app.fullName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase() : '?'}
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xl font-bold text-gray-900 dark:text-white">${app.fullName}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-300 mt-1"><i class="fas fa-envelope mr-1"></i>${app.emailAddress}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-300 mt-1"><i class="fas fa-phone mr-1"></i>${app.phoneNumber || 'N/A'}</div>
                            </div>
                            <div class="text-sm text-gray-400">Date of Birth: <span class="text-gray-700 dark:text-gray-200">${app.dateOfBirth || 'N/A'}</span></div>
                        </div>
                        <div class="application-card"><h3 class="text-lg font-semibold">Academic Information</h3><p><strong>Preferred University:</strong> ${app.preferredUniversity || ''}</p><p><strong>Country:</strong> ${app.country || ''}</p></div>
                        <div class="application-card"><h3 class="text-lg font-semibold">Uploaded Documents</h3>${documentsHtml}</div>
                    </div>`;
                showModal();
            } catch (error) {
                console.error('Error viewing application:', error);
                showFetchError('Unable to load application details.');
            } finally {
                showLoading(false);
            }
        }

        async function deleteApplication(applicationId) {
            if (!confirm('Are you sure you want to delete this application?')) return;
            try {
                const response = await fetch(`/api/admin/applications/${applicationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                await handleApiResponse(response);
                showNotification('Application deleted successfully', 'success');
                loadApplications();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function showLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        function showModal() { applicationModal.classList.add('show'); }
        function hideModal() { applicationModal.classList.remove('show'); }

        function showCreateModal() {
            currentStepIndex = 0;
            showStep(0);
            createApplicationModal.classList.add('show');
        }
        function hideCreateModal() { createApplicationModal.classList.remove('show'); }

        async function handleApplicationSubmit(e) {
            e.preventDefault();
            const form = e.target;
            if (!Array.from(form.querySelectorAll('[required]')).every(el => el.checkValidity())) {
                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    const invalidInput = Array.from(step.querySelectorAll('[required]')).find(el => !el.checkValidity());
                    if (invalidInput) {
                        showStep(i);
                        invalidInput.reportValidity();
                        return;
                    }
                }
            }

            const formData = new FormData(form);
            // Debug: log all form data before submit
            for (let [key, value] of formData.entries()) {
                console.log('FORM FIELD:', key, value);
            }
            const applicationId = form.dataset.applicationId;
            const url = applicationId ? `/api/admin/applications/${applicationId}` : '/api/admin/applications';
            const method = applicationId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                await handleApiResponse(response);
                showNotification(`Application ${applicationId ? 'updated' : 'created'} successfully`, 'success');
                hideCreateModal();
                loadApplications();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function loadScholarshipsAndPopulateSelects(selectedUniversity = null) {
            try {
                const response = await fetch('/api/scholarships', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const scholarships = await response.json();
                const universitySelect = document.getElementById('preferredUniversity');
                const scholarshipIdInput = document.getElementById('scholarship_id');
                const countryInput = document.getElementById('countryFilter');

                universitySelect.innerHTML = '<option value="">Select a university</option>';
                scholarships.forEach(sch => {
                    const option = document.createElement('option');
                    option.value = sch.name;
                    option.textContent = sch.name;
                    option.dataset.scholarshipId = sch.id;
                    option.dataset.country = sch.country || '';
                    if (selectedUniversity === sch.name) {
                        option.selected = true;
                    }
                    universitySelect.appendChild(option);
                });

                function syncFields() {
                    const selectedOption = universitySelect.options[universitySelect.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        scholarshipIdInput.value = selectedOption.dataset.scholarshipId;
                        // We no longer auto-fill the country. It's an independent selection.
                    } else {
                        scholarshipIdInput.value = '';
                    }
                }
                universitySelect.addEventListener('change', syncFields);
                if (selectedUniversity) syncFields();
            } catch (error) {
                showNotification('Failed to load scholarships', 'error');
            }
        }

        async function updateApplication(applicationId) {
            try {
                showLoading(true);
                const response = await fetch(`/api/admin/applications/${applicationId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const appData = await handleApiResponse(response);
                if (!appData) return;
                
                profilePictureInput.required = false;

                await loadScholarshipsAndPopulateSelects(appData.preferred_university);
                
                const fieldMapping = {
                    full_name: 'fullName', email_address: 'emailAddress', date_of_birth: 'dob', gender: 'gender',
                    phone_number: 'phone', address: 'address', preferred_university: 'preferredUniversity',
                    country: 'countryFilter', academic_level: 'academicLevel', intended_major: 'intendedMajor',
                    gpa_academic_performance: 'gpaAcademicPerformance', extracurricular_activities: 'extracurricularActivities',
                    parent_guardian_name: 'parentGuardianName', parent_guardian_contact: 'parentGuardianContact',
                    financial_need_statement: 'financialNeedStatement', how_heard_about: 'howHeardAbout',
                    motivation_statement: 'motivationStatement'
                };

                for (const [key, id] of Object.entries(fieldMapping)) {
                    const el = document.getElementById(id);
                    if (el) el.value = appData[key] || '';
                }
                document.querySelector('input[name="terms_agreed"]').checked = !!appData.terms_agreed;

                if (profilePreview) {
                    const imageUrl = appData.profile_picture_url ? `/${appData.profile_picture_url}` : defaultAvatar;
                    profilePreview.src = imageUrl;
                    profilePreview.onerror = () => {
                        profilePreview.src = defaultAvatar;
                    };
                    profilePreview.classList.remove('hidden');
                    profilePlaceholder.classList.add('hidden');
                }
                
                adminScholarshipForm.dataset.applicationId = applicationId;
                document.querySelector('#createApplicationModal h2').textContent = 'Update Application';
                adminScholarshipForm.querySelector('button[type="submit"]').textContent = 'Update Application';
                showCreateModal();
            } catch (error) {
                console.error('Error loading application for update:', error);
                showFetchError('Unable to load application details.');
            } finally {
                showLoading(false);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }



        function showFetchError(message, retryCallback) {
            const el = document.getElementById('fetchError');
            el.querySelector('span').textContent = message;
            el.classList.remove('hidden');
            const retryBtn = el.querySelector('button');
            retryBtn.classList.toggle('hidden', !retryCallback);
            if(retryCallback) retryBtn.onclick = () => {
                el.classList.add('hidden');
                    retryCallback();
                };
        }
        function hideFetchError() {
            document.getElementById('fetchError').classList.add('hidden');
        }

        function showFetchError(message, retryCallback = null) {
            const el = document.getElementById('fetchError');
            const messageEl = document.getElementById('fetchErrorMessage');
            const retryBtn = document.getElementById('retryFetchBtn');
            
            messageEl.textContent = message;
            el.classList.remove('hidden');
            
            if(retryCallback) retryBtn.onclick = () => {
                el.classList.add('hidden');
                retryCallback();
            };
        }

        async function handleApiResponse(response) {
            if (!response.ok) {
                // If permission denied, session is likely invalid, so log out.
                if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired or permission denied. Please log in again.', 'error');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    // Use a short delay to allow the user to see the notification
                    setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                }
                const errorResult = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorResult.message || 'An unknown error occurred');
            }
            if (response.status === 204) return null; 
            return response.json();
        }

        // Status Management Functions
        async function updateApplicationStatus(applicationId) {
            try {
                // Get current application data
                const response = await fetch(`/api/admin/applications/${applicationId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const appData = await handleApiResponse(response);
                if (!appData) return;

                // Convert to camelCase for consistent field access
                const app = toCamelCase(appData);

                // Populate the status update modal
                document.getElementById('statusApplicationId').value = applicationId;
                document.getElementById('statusSelect').value = app.status || 'pending';
                document.getElementById('reviewerNotes').value = app.reviewerNotes || '';

                // Show the modal
                document.getElementById('statusUpdateModal').classList.add('show');
            } catch (error) {
                console.error('Error loading application for status update:', error);
                showNotification('Unable to load application details.', 'error');
            }
        }

        // Message Management Functions
        function sendMessageToUser(applicationId, userEmail, userName) {
            // Populate the message modal
            document.getElementById('messageApplicationId').value = applicationId;
            document.getElementById('messageUserEmail').value = userEmail;
            document.getElementById('messageApplicantInfo').innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                        <span class="text-primary-600 dark:text-primary-400 font-semibold">${userName ? userName.charAt(0).toUpperCase() : 'U'}</span>
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900 dark:text-white">${userName || 'Unknown User'}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${userEmail}</div>
                    </div>
                </div>
            `;

            // Clear previous form data
            document.getElementById('messageTitle').value = '';
            document.getElementById('messageContent').value = '';

            // Show the modal
            document.getElementById('sendMessageModal').classList.add('show');
        }

        function setMessageTemplate(type) {
            const titleInput = document.getElementById('messageTitle');
            const messageInput = document.getElementById('messageContent');
            
            const templates = {
                approved: {
                    title: 'Application Approved',
                    message: 'Congratulations! Your scholarship application has been approved. We are pleased to inform you that your application has met all our requirements and you have been selected for the scholarship. You will receive further details about the next steps via email. Thank you for your interest in our program.'
                },
                rejected: {
                    title: 'Application Status Update',
                    message: 'Thank you for your interest in our scholarship program. After careful review of your application, we regret to inform you that we are unable to approve your application at this time. We encourage you to apply again in the future. We wish you the best in your academic pursuits.'
                },
                under_review: {
                    title: 'Application Under Review',
                    message: 'Your scholarship application is currently under review by our selection committee. This process typically takes 2-3 weeks. We will notify you as soon as a decision has been made. Thank you for your patience.'
                },
                waitlisted: {
                    title: 'Application Waitlisted',
                    message: 'Your scholarship application has been placed on our waitlist. This means that while your application meets our criteria, we have limited spots available. We will contact you if a position becomes available. Thank you for your understanding.'
                }
            };
            
            if (templates[type]) {
                titleInput.value = templates[type].title;
                messageInput.value = templates[type].message;
            }
        }


    </script>
</body>
</html>
