<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applications Management - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3b82f6', // blue-500
                            600: '#2563eb', // blue-600
                        },
                        success: {
                            500: '#10b981', // emerald-500
                            600: '#059669', // emerald-600
                        },
                        warning: {
                            500: '#f59e0b', // amber-500
                            600: '#d97706', // amber-600
                        },
                        danger: {
                            500: '#ef4444', // red-500
                            600: '#dc2626', // red-600
                        },
                        info: {
                            400: '#60a5fa', // blue-400
                            600: '#2563eb', // blue-600
                            900: '#1e3a8a', // blue-900
                        }
                    }
                }
            }
        }
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var fab=document.getElementById('admin-fab-menu'), ov=document.getElementById('admin-fab-overlay'), md=document.getElementById('admin-fab-modal'), x=document.getElementById('admin-fab-close');
        if(fab&&ov&&md){ function o(){ov.classList.remove('hidden'); md.classList.remove('hidden');} function c(){ov.classList.add('hidden'); md.classList.add('hidden');}
          fab.addEventListener('click',o); ov.addEventListener('click',c); if(x) x.addEventListener('click',c); }
      });
    </script>
    <script>
      (function() {
        try {
          var theme = localStorage.getItem('color-theme');
          if (
            theme === 'dark' ||
            (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
          ) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        } catch (e) {}
      })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/admin-layout.css">
    <script src="js/include-admin-sidebar.js" defer></script>
    <script src="js/include-admin-header.js" defer></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --table-header: #f9fafb;
            --table-border: #e5e7eb;
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --input-bg: #1f2937;
            --input-border: #374151;
            --table-header: #1f2937;
            --table-border: #374151;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Main content styles */
        .main-content {
            padding-top: 4rem;
            min-height: 100vh;
            background-color: var(--bg-primary);
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .status-badge.approved {
            background-color: rgba(16, 185, 129, 0.2);
            color: #059669;
        }

        .status-badge.rejected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .dark .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .dark .status-badge.approved {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .dark .status-badge.rejected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-badge.under-review {
            background-color: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .dark .status-badge.under-review {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-badge.waitlisted {
            background-color: rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }

        .dark .status-badge.waitlisted {
            background-color: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }

        .modal-content {
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid var(--text-secondary);
            border-radius: 50%;
            border-top-color: var(--text-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0 !important;
                padding: 4rem 1rem 1rem 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0 !important;
                padding: 4rem 1rem 1rem 1rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Application details card */
        .application-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .application-card h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .application-card p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Document preview */
        .document-preview {
            border: 1px dashed var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            cursor: pointer;
        }

        .document-preview:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
            max-width: 24rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .notification.success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #059669;
            border: 1px solid #059669;
        }

        .notification.error {
            background-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="admin-layout bg-white text-black transition-colors duration-200">
    <!-- Admin Sidebar Container -->
    <div id="admin-sidebar-container"></div>

    <!-- Navigation Bar -->
    <div id="admin-header-container" data-page-title="Applications">
        <span id="adminName"></span>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Bulk Upload Applications (CSV)</h2>
                <button id="closeBulkUploadModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="text-sm text-gray-600 dark:text-gray-300">
                    Required headers: <code>full_name, email_address, scholarship_id, date_of_birth</code>.<br>
                    Optional headers include: gender, phone_number, address, preferred_university, country, academic_level, intended_major, gpa_academic_performance, extracurricular_activities, parent_guardian_name, parent_guardian_contact, financial_need_statement, how_heard_about, motivation_statement, terms_agreed.
                </div>
                <form id="bulkUploadForm" class="space-y-3">
                    <label class="block text-sm font-medium">Apply to Scholarship (optional):</label>
                    <select id="bulkScholarshipSelect" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- Select scholarship to apply all rows --</option>
                    </select>
                    <input type="file" id="bulkCsvFile" accept=".csv,text/csv" required class="block w-full text-sm" />
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelBulkUpload" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Upload</button>
                    </div>
                </form>
                <div id="bulkUploadResult" class="text-sm hidden"></div>
                <div id="bulkUploadActions" class="hidden flex flex-wrap gap-2 pt-2">
                    <button id="removeDuplicateRowsBtn" class="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Remove Duplicates</button>
                    <button id="exportProblemRowsBtn" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Export Problem Rows (CSV)</button>
                    <button id="openFixProblemsBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Open Fix Panel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fix Problems Drawer -->
    <div id="fixProblemsDrawer" class="fixed top-0 right-0 w-full max-w-3xl h-full bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full transition-transform z-[1100]">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <div class="text-lg font-bold">Fix Problem Rows</div>
            <button id="closeFixPanel" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 overflow-auto h-[calc(100%-56px)]">
            <div id="fixProblemsContainer" class="space-y-4"></div>
            <div class="pt-4 flex justify-end gap-2">
                <button id="applyFixesBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Re-validate & Insert</button>
            </div>
        </div>
    </div>
    <!-- Main Content -->
    <main class="admin-main-content w-full bg-transparent dark:bg-transparent">
        <div class="admin-content-container">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 w-full">
                        <button id="createApplicationBtn" type="button"
                            class="w-full md:w-auto h-12 px-5 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-colors duration-200 flex items-center justify-center whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i>Create Application
                        </button>


                        <button id="bulkUploadBtn" type="button"
                            class="w-full md:w-auto h-12 px-5 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors duration-200 flex items-center justify-center whitespace-nowrap">
                            <i class="fas fa-file-upload mr-2"></i>Bulk Upload CSV
                        </button>
                        
                        <div class="relative w-full lg:col-span-2">
                            <input type="text" id="searchInput" placeholder="Search applications..." 
                                class="h-12 w-full pl-12 pr-5 text-base rounded-xl border border-gray-300 dark:border-gray-600 
                                bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 
                                focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 text-lg"></i>
                        </div>
                        <div>
                            <select id="sortSelect" class="w-full md:w-auto h-12 px-4 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="">Sort by</option>
                                <option value="date_desc">Date (newest)</option>
                                <option value="date_asc">Date (oldest)</option>
                            </select>
                        </div>
                        
                    </div>
                </div>

                <!-- Applications Table -->
                <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Applicant
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        University
                                    </th>
                                    
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status
                                    </th>
                                    
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Applied Date
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTable" class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Applications will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingIndicator" class="p-4 text-center hidden">
                        <div class="loading-spinner inline-block"></div>
                        <span class="ml-2 text-gray-600 dark:text-gray-400">Loading applications...</span>
                    </div>
                    <div id="noApplications" class="p-8 text-center text-gray-500 dark:text-gray-400 hidden">
                        No applications found matching your criteria.
                    </div>
                    <div id="fetchError" class="p-8 text-center text-red-600 dark:text-red-400 hidden">
                        <span id="fetchErrorMessage"></span>
                        <br>
                        <button id="retryFetchBtn" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600">Retry</button>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Showing <span id="startRange">1</span> to <span id="endRange">10</span> of <span id="totalApplications">0</span> applications
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPage" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                            Previous
                        </button>
                        <button id="nextPage" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Guaranteed Mobile FAB + Modal -->
    <button id="admin-fab-menu" aria-label="Open admin menu" class="fixed bottom-4 right-4 w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center z-[20001]"><i class="fas fa-bars"></i></button>
    <div id="admin-fab-overlay" class="fixed inset-0 bg-black/40 hidden z-[19990]"></div>
    <div id="admin-fab-modal" class="fixed bottom-20 left-4 right-4 bg-white text-black dark:bg-white dark:text-black rounded-2xl shadow-2xl hidden z-[20000] max-h-[70vh] overflow-y-auto">
      <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between"><span class="font-semibold">Admin Menu</span><button id="admin-fab-close" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-times"></i></button></div>
      <div class="p-2">
        <a href="admin_dashboard.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>Dashboard</span></a>
        <a href="admin_users.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-users w-5 text-center"></i><span>Users</span></a>
        <a href="admin_rolesPermissions.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-user-shield w-5 text-center"></i><span>Roles</span></a>
        <a href="admin_scholarship.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-graduation-cap w-5 text-center"></i><span>Scholarships</span></a>
        <a href="admin_applications.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-file-alt w-5 text-center"></i><span>Applications</span></a>
        <a href="admin_partners.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-handshake w-5 text-center"></i><span>Partners</span></a>
        <a href="admin_services.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-briefcase w-5 text-center"></i><span>Services</span></a>
        <a href="admin_email_template.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-envelope w-5 text-center"></i><span>Email Templates</span></a>
        <a href="admin_help.html" class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-question w-5 text-center"></i><span>Help</span></a>
      </div>
    </div>

    <!-- Application Details Modal -->
    <div id="applicationModal" class="modal-overlay">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">Application Details</h2>
                <button id="closeModal" type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="applicationDetails">
                <!-- Application details will be loaded here -->
            </div>
            
            <div id="applicationActions" class="flex justify-end space-x-3 mt-6">
                <button id="closeBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Create Application Modal -->
    <div id="createApplicationModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Create New Application</h2>
                <button id="closeCreateModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="adminScholarshipForm" class="max-w-3xl mx-auto bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white p-8 rounded-lg shadow-lg border-l-4 border-primary-500" enctype="multipart/form-data">
                <input type="hidden" name="scholarship_id" id="scholarship_id" value="">
                <!-- Step 1: Personal Information -->
                <div class="form-step" id="step-1">
                    <div class="mb-6 flex flex-col items-center">
                        <label for="profilePicture" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Profile Picture</label>
                        <div id="profileUploadArea" class="relative flex flex-col items-center justify-center w-32 h-32 rounded-full border-2 border-dashed border-primary-500 dark:border-primary-400 bg-gray-100 dark:bg-dark-900 cursor-pointer transition hover:bg-primary-50 dark:hover:bg-primary-900/20 mb-2">
                            <img id="profilePreview" class="absolute w-32 h-32 rounded-full object-cover hidden z-10" alt="Profile Preview">
                            <div id="profilePlaceholder" class="flex flex-col items-center justify-center h-full w-full z-0">
                                <i class="fas fa-user-circle text-6xl text-gray-300 dark:text-white"></i>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Drag & drop or click</span>
                            </div>
                            <input type="file" id="profilePicture" name="profile_picture_url" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" required>
                        </div>
                        <button type="button" id="profileUploadBtn" class="mt-2 px-4 py-2 bg-primary-500 text-white rounded shadow hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500">Choose Photo</button>
                        <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Max size: 2MB. JPG, PNG, or GIF.</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="fullName" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Full Name</label>
                            <input type="text" id="fullName" name="full_name" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. Jane Doe" required>
                        </div>
                        <div>
                            <label for="emailAddress" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Email Address</label>
                            <input type="email" id="emailAddress" name="email_address" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. jane@email.com" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="dob" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Date of Birth</label>
                            <input type="date" id="dob" name="date_of_birth" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                        </div>
                        <div>
                            <label for="gender" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Gender</label>
                            <select id="gender" name="gender" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select gender</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="phone" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Phone Number</label>
                            <input type="tel" id="phone" name="phone_number" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. +250 123 456 789" required>
                        </div>
                        <div>
                            <label for="address" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Address</label>
                            <input type="text" id="address" name="address" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. 123 Main St, Kigali" required>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" class="next-step bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Next</button>
                    </div>
                </div>
                <!-- Step 2: Academic Information -->
                <div class="form-step hidden" id="step-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="preferredUniversity" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Preferred University</label>
                            <select id="preferredUniversity" name="preferred_university" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select a university</option>
                            </select>
                        </div>
                        <div>
                            <label for="country" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Country</label>
                            <select id="countryFilter" name="country" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select a country</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="academicLevel" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Academic Level</label>
                            <select id="academicLevel" name="academic_level" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" required>
                                <option value="">Select level</option>
                                <option value="undergraduate">Undergraduate</option>
                                <option value="graduate">Graduate</option>
                                <option value="phd">PhD</option>
                            </select>
                        </div>
                        <div>
                            <label for="intendedMajor" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Intended Major/Field of Study</label>
                            <input type="text" id="intendedMajor" name="intended_major" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. Computer Science">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="gpa" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">GPA / Academic Performance</label>
                            <input type="text" id="gpaAcademicPerformance" name="gpa_academic_performance" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. 3.8/4.0">
                        </div>
                        <div>
                            <label for="documents" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Upload Documents</label>
                            <input type="file" id="documents" name="uploaded_documents_json" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" multiple>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="extracurriculars" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Extracurricular Activities</label>
                        <textarea id="extracurricularActivities" name="extracurricular_activities" rows="2" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="List your activities, clubs, sports, etc."></textarea>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" class="prev-step bg-gray-300 text-gray-700 px-8 py-3 rounded font-semibold hover:bg-gray-400 transition-all duration-300">Back</button>
                        <button type="button" class="next-step bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Next</button>
                    </div>
                </div>
                <!-- Step 3: Additional Information -->
                <div class="form-step hidden" id="step-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="parentName" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian Name</label>
                            <input type="text" id="parentGuardianName" name="parent_guardian_name" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. John Doe">
                        </div>
                        <div>
                            <label for="parentContact" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian Contact</label>
                            <input type="text" id="parentGuardianContact" name="parent_guardian_contact" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. +250 987 654 321">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="financialNeed" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Financial Need Statement</label>
                        <textarea id="financialNeedStatement" name="financial_need_statement" rows="3" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="Describe your financial situation and why you need this scholarship."></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="referral" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">How did you hear about this scholarship?</label>
                        <input type="text" id="howHeardAbout" name="how_heard_about" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="e.g. School, Social Media, Friend">
                    </div>
                    <div class="mb-6">
                        <label for="message" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Why Are You Applying?</label>
                        <textarea id="motivationStatement" name="motivation_statement" rows="4" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-dark-900 text-black dark:text-black" placeholder="Briefly explain your motivation..."></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="terms_agreed" required>
                            <span class="ml-2 text-gray-700 dark:text-gray-300">I agree to the terms and conditions</span>
                        </label>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" class="prev-step bg-gray-300 text-gray-700 px-8 py-3 rounded font-semibold hover:bg-gray-400 transition-all duration-300">Back</button>
                        <button type="submit" class="bg-primary-500 text-white px-8 py-3 rounded font-semibold hover:bg-primary-600 transition-all duration-300">Submit Application</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Update Application Status</h2>
                <button id="closeStatusModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="statusUpdateForm" class="space-y-4">
                <input type="hidden" id="statusApplicationId" name="applicationId">
                
                <div>
                    <label for="statusSelect" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Application Status</label>
                    <select id="statusSelect" name="status" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" required>
                        <option value="pending">Pending</option>
                        <option value="under_review">Under Review</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="waitlisted">Waitlisted</option>
                    </select>
                </div>
                
                <div>
                    <label for="reviewerNotes" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Reviewer Notes (Optional)</label>
                    <textarea id="reviewerNotes" name="reviewer_notes" rows="4" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="Add any notes about this application..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelStatusUpdate" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600">
                        Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Applicant Modal -->
    <div id="editApplicantModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Edit Applicant</h2>
                <button id="closeEditApplicant" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editApplicantForm" class="space-y-4">
                <input type="hidden" id="editApplicationId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Full name</label>
                        <input id="eaFullName" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Email</label>
                        <input id="eaEmail" type="email" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Phone</label>
                        <input id="eaPhone" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Date of birth</label>
                        <input id="eaDob" type="date" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Gender</label>
                        <select id="eaGender" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                            <option value="">â€”</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Address</label>
                        <input id="eaAddress" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">University</label>
                        <input id="eaUniversity" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Country</label>
                        <input id="eaCountry" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Academic level</label>
                        <select id="eaAcademicLevel" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                            <option value="">-- Select level --</option>
                            <option value="undergraduate">Undergraduate</option>
                            <option value="graduate">Graduate</option>
                            <option value="phd">PhD</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Intended major</label>
                        <input id="eaIntendedMajor" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">GPA / Academic performance</label>
                        <input id="eaGpa" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Extracurricular activities</label>
                        <textarea id="eaExtracurriculars" rows="2" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian name</label>
                        <input id="eaParentName" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Parent/Guardian contact</label>
                        <input id="eaParentContact" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Financial need statement</label>
                        <textarea id="eaFinancialNeed" rows="2" class="w-full px-4 py-2 border dark;border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">How did you hear about this scholarship?</label>
                        <input id="eaHowHeard" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Motivation statement</label>
                        <textarea id="eaMotivation" rows="3" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white"></textarea>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="eaTerms">
                            <span class="ml-2">Terms agreed</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelEditApplicant" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div id="sendMessageModal" class="modal-overlay">
        <div class="modal-content bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-black dark:text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-black dark:text-white">Send Message to Applicant</h2>
                <button id="closeMessageModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="sendMessageForm" class="space-y-4">
                <input type="hidden" id="messageApplicationId" name="applicationId">
                <input type="hidden" id="messageUserEmail" name="userEmail">
                
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Applicant</label>
                    <div id="messageApplicantInfo" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                        <!-- Applicant info will be populated here -->
                    </div>
                </div>
                
                <div>
                    <label for="messageTitle" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Message Title</label>
                    <input type="text" id="messageTitle" name="title" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="e.g., Application Update" required>
                </div>
                
                <div>
                    <label for="messageContent" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Message Content</label>
                    <textarea id="messageContent" name="message" rows="6" class="w-full px-4 py-2 border dark:border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 text-black dark:text-white" placeholder="Type your message here..." required></textarea>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="setMessageTemplate('approved')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 dark:bg-green-900 dark:text-green-300">
                        Application Approved
                    </button>
                    <button type="button" onclick="setMessageTemplate('rejected')" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-300">
                        Application Rejected
                    </button>
                    <button type="button" onclick="setMessageTemplate('under_review')" class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-300">
                        Under Review
                    </button>
                    <button type="button" onclick="setMessageTemplate('waitlisted')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300">
                        Waitlisted
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelMessage" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600">
                        Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // State management
        let applications = [];
        let currentPage = 1;
        const applicationsPerPage = 10;
        // sortMode is declared earlier
        let minScoreFilter = '';
        let currentApplicationId = null;
        let availableScholarships = [];
        let filteredApplications = [];
        let currentStepIndex = 0;

        // CRUD for admin_applications_simple
        let simpleApplications = [];

        // Helper function to convert snake_case to camelCase for application objects
        function toCamelCase(obj) {
            if (!obj) return obj;
            const map = {
                application_id: 'applicationId',
                full_name: 'fullName',
                email_address: 'emailAddress',
                profile_picture_url: 'profilePictureUrl',
                preferred_university: 'preferredUniversity',
                application_date: 'applicationDate',
                phone_number: 'phoneNumber',
                date_of_birth: 'dateOfBirth',
                uploaded_documents_json: 'uploadedDocumentsJson',
                academic_level: 'academicLevel',
                intended_major: 'intendedMajor',
                gpa_academic_performance: 'gpaAcademicPerformance',
                extracurricular_activities: 'extracurricularActivities',
                parent_guardian_name: 'parentGuardianName',
                parent_guardian_contact: 'parentGuardianContact',
                financial_need_statement: 'financialNeedStatement',
                how_heard_about: 'howHeardAbout',
                motivation_statement: 'motivationStatement',
                reviewer_notes: 'reviewerNotes',
                terms_agreed: 'termsAgreed',
                // Admin-dashboard recent applications fields
                id: 'applicationId',
                created_at: 'applicationDate',
                applicant_name: 'fullName',
                applicant_email: 'emailAddress',
                scholarship_title: 'scholarshipTitle',
                amount: 'awardAmount'
            };
            const newObj = {};
            for (const key in obj) {
                newObj[map[key] || key] = obj[key];
            }
            return newObj;
        }

        function mapApplicationsToCamelCase(apps) {
            return apps.map(toCamelCase);
        }
        // DOM Elements
        const applicationsTable = document.getElementById('applicationsTable');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noApplications = document.getElementById('noApplications');
        const searchInput = document.getElementById('searchInput');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const startRange = document.getElementById('startRange');
        const endRange = document.getElementById('endRange');
        const totalApplications = document.getElementById('totalApplications');
        const applicationModal = document.getElementById('applicationModal');
        const applicationDetails = document.getElementById('applicationDetails');
        const closeBtn = document.getElementById('closeBtn');
        const closeModalBtn = document.getElementById('closeModal');
        const createApplicationBtn = document.getElementById('createApplicationBtn');
        const createApplicationModal = document.getElementById('createApplicationModal');
        const adminScholarshipForm = document.getElementById('adminScholarshipForm');
        const profilePreview = document.getElementById('profilePreview');
        const profilePlaceholder = document.getElementById('profilePlaceholder');
        const profilePictureInput = document.getElementById('profilePicture');
        const profileUploadBtn = document.getElementById('profileUploadBtn');
        const countryFilterInput = document.getElementById('countryFilter');
        
        const defaultAvatar = 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg>';
        
        // --- Country List ---
        const countries = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];
        
        // Robust score extractor to handle various API field names and formats
        // Removed match score and country derivation helpers (columns removed)
        
        // Make steps available everywhere
        const steps = Array.from(document.querySelectorAll('#adminScholarshipForm .form-step'));
        
        function showStep(index) {
            steps.forEach((step, i) => {
                const shouldHide = i !== index;
                step.classList.toggle('hidden', shouldHide);
            });
            
            const firstInput = steps[index].querySelector('input, select, textarea');
            if (firstInput) {
                firstInput.focus();
            }
        }

        function populateCountries() {
            const countrySelect = document.getElementById('countryFilter');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        function goToNextStep() {
            const currentStep = steps[currentStepIndex];
            const inputs = Array.from(currentStep.querySelectorAll('input[required], select[required], textarea[required]'));

            if (inputs.every(input => input.checkValidity())) {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                showStep(currentStepIndex);
                }
            } else {
                inputs.find(input => !input.checkValidity()).reportValidity();
            }
        }

        function goToPrevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                showStep(currentStepIndex);
            }
        }

        function setupMultiStepNavigation() {
            document.querySelectorAll('#adminScholarshipForm .next-step').forEach(btn => btn.addEventListener('click', goToNextStep));
            document.querySelectorAll('#adminScholarshipForm .prev-step').forEach(btn => btn.addEventListener('click', goToPrevStep));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('adminName').textContent = user.fullName || 'Admin';
            
            setupEventListeners();
            setupAdditionalEventListeners();
            loadApplications();
            populateCountries();
        });

        function setupEventListeners() {
            try {
            if (searchInput) searchInput.addEventListener('input', filterApplications);
            if (prevPageBtn) prevPageBtn.addEventListener('click', () => changePage(-1));
            if (nextPageBtn) nextPageBtn.addEventListener('click', () => changePage(1));
            if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); hideModal(); });
            if (closeModalBtn) closeModalBtn.addEventListener('click', (e)=>{ e.preventDefault(); hideModal(); });
            if (applicationModal) {
                applicationModal.addEventListener('click', (e) => {
                    if (e.target === applicationModal) hideModal();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && applicationModal.classList.contains('show')) hideModal();
                });
            }
            if (document.getElementById('logoutBtn')) {
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                });
            }
            if (createApplicationBtn) {
                createApplicationBtn.addEventListener('click', async () => {
                        try {
                    adminScholarshipForm.reset();
                    adminScholarshipForm.dataset.applicationId = '';
                            
                            const titleEl = document.querySelector('#createApplicationModal h2');
                            if (titleEl) {
                                titleEl.textContent = 'Create New Application';
                            }
                            
                            const submitBtn = adminScholarshipForm.querySelector('button[type="submit"]');
                            if (submitBtn) {
                                submitBtn.textContent = 'Submit Application';
                            }
                            
                            if (profilePictureInput) {
                    profilePictureInput.required = true;
                            }
                            
                    await loadScholarshipsAndPopulateSelects();
                    showCreateModal();
                        } catch (error) {
                            console.error('Error in create application click handler:', error);
                            // Even if there's an error, try to show the modal
                            showCreateModal();
                        }
                });
                } else {
                    console.error('createApplicationBtn not found!');
            }
            if (document.getElementById('closeCreateModal')) document.getElementById('closeCreateModal').addEventListener('click', hideCreateModal);
            // Close create modal on overlay click and Escape
            if (createApplicationModal) {
                createApplicationModal.addEventListener('click', (e)=>{ if (e.target === createApplicationModal) hideCreateModal(); });
                document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && createApplicationModal.classList.contains('show')) hideCreateModal(); });
            }
            if (adminScholarshipForm) adminScholarshipForm.addEventListener('submit', handleApplicationSubmit);
            } catch (error) {
                console.error('Error in setupEventListeners:', error);
            }
        }
        
        // Additional event listeners and setup functions
        function setupAdditionalEventListeners() {
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) sortSelect.addEventListener('change', (e)=>{ sortMode = e.target.value; filterApplications(); });
            const scoreFilterSelect = document.getElementById('scoreFilterSelect');
            

            // Profile image preview + drag-drop
            if (profileUploadBtn && profilePictureInput) {
                const showPreview = (file) => {
                    if (!file) return;
                    const url = URL.createObjectURL(file);
                    profilePreview.src = url;
                    profilePreview.onload = () => URL.revokeObjectURL(url);
                    profilePreview.classList.remove('hidden');
                    profilePlaceholder.classList.add('hidden');
                };
                profileUploadBtn.addEventListener('click', () => profilePictureInput.click());
                profilePictureInput.addEventListener('change', () => showPreview(profilePictureInput.files[0]));
                const area = document.getElementById('profileUploadArea');
                if (area) {
                    ['dragenter','dragover'].forEach(evt => area.addEventListener(evt, (e)=>{ e.preventDefault(); area.classList.add('ring-2','ring-primary-500'); }));
                    ['dragleave','drop'].forEach(evt => area.addEventListener(evt, (e)=>{ e.preventDefault(); area.classList.remove('ring-2','ring-primary-500'); }));
                    area.addEventListener('drop', (e)=>{
                        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
                        if (f) {
                            const dt = new DataTransfer();
                            dt.items.add(f);
                            profilePictureInput.files = dt.files;
                            showPreview(f);
                        }
                    });
                }
            }
            
            // Bulk Upload wiring
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            const bulkUploadModal = document.getElementById('bulkUploadModal');
            const closeBulkUploadModal = document.getElementById('closeBulkUploadModal');
            const cancelBulkUpload = document.getElementById('cancelBulkUpload');
            const bulkUploadForm = document.getElementById('bulkUploadForm');
            const bulkUploadResult = document.getElementById('bulkUploadResult');

            const showBulkModal = () => bulkUploadModal && bulkUploadModal.classList.add('show');
            const hideBulkModal = () => { if (bulkUploadModal) bulkUploadModal.classList.remove('show'); if (bulkUploadResult) { bulkUploadResult.classList.add('hidden'); bulkUploadResult.innerHTML=''; } };
            if (bulkUploadBtn) bulkUploadBtn.addEventListener('click', showBulkModal);
            if (closeBulkUploadModal) closeBulkUploadModal.addEventListener('click', hideBulkModal);
            if (cancelBulkUpload) cancelBulkUpload.addEventListener('click', hideBulkModal);
            if (bulkUploadModal) bulkUploadModal.addEventListener('click', (e)=>{ if(e.target===bulkUploadModal) hideBulkModal(); });

            // Populate scholarship list for bulk select
            const bulkScholarshipSelect = document.getElementById('bulkScholarshipSelect');
            async function populateBulkScholarships() {
                if (!bulkScholarshipSelect) return;
                try {
                    const resp = await fetch('/api/scholarships');
                    const list = await resp.json();
                    window.__scholarshipList = Array.isArray(list) ? list : [];
                    bulkScholarshipSelect.innerHTML = '<option value="">-- Select scholarship to apply all rows --</option>';
                    (window.__scholarshipList).forEach(s => {
                        if (s && s.id && s.name) {
                            const opt = document.createElement('option');
                            opt.value = s.id;
                            opt.textContent = `${s.name} (ID ${s.id})`;
                            bulkScholarshipSelect.appendChild(opt);
                        }
                    });
                } catch {}
            }
            populateBulkScholarships();

            // Helper: render bulk summary + toggle actions
            function renderBulkSummary(s) {
                const bulkUploadResultEl = document.getElementById('bulkUploadResult');
                const bulkActionsEl = document.getElementById('bulkUploadActions');
                if (!bulkUploadResultEl || !s) return;
                bulkUploadResultEl.className = 'text-sm p-3 rounded-md bg-gray-100 dark:bg-gray-700';
                bulkUploadResultEl.innerHTML = `
                    <div class="font-semibold mb-2">Upload Summary</div>
                    <div>Inserted: <strong>${s.inserted||0}</strong></div>
                    <div>Duplicates: <strong class="text-yellow-700 dark:text-yellow-400">${s.duplicates||0}</strong></div>
                    <div>Errors: <strong class="text-red-700 dark:text-red-400">${s.errors||0}</strong></div>
                    <div class="mt-2 max-h-56 overflow-auto border-t border-gray-300 dark:border-gray-600 pt-2">${(Array.isArray(s.rows)?s.rows:[]).map(r=>`<div class=\"mb-1\"><code>#${r.row||'?'}:</code> ${r.status}${r.email?` - ${r.email}`:''}${r.scholarship_id?` (scholarship ${r.scholarship_id})`:''}${r.message?` - ${r.message}`:''}</div>`).join('')}</div>`;
                bulkUploadResultEl.classList.remove('hidden');
                if (bulkActionsEl) {
                    if ((s.duplicates||0) > 0 || (s.errors||0) > 0) {
                        bulkActionsEl.classList.remove('hidden');
                    } else {
                        bulkActionsEl.classList.add('hidden');
                    }
                }
            }

            if (bulkUploadForm) bulkUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('bulkCsvFile');
                const file = fileInput && fileInput.files && fileInput.files[0];
                if (!file) return;
                try {
                    const fd = new FormData();
                    fd.append('file', file);
                    const selectedScholarshipId = (bulkScholarshipSelect && bulkScholarshipSelect.value) ? bulkScholarshipSelect.value : '';
                    if (selectedScholarshipId) fd.append('scholarship_id', selectedScholarshipId);
                    const resp = await fetch('/api/admin-dashboard/applications/bulk-upload', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: fd
                    });
                    const result = await handleApiResponse(resp);
                    if (!result) return;
                    const s = result.summary || {};
                    if (bulkUploadResult) { renderBulkSummary(s); }
                    // Reveal batch actions if there are any problems
                    window.__lastBulkSummary = s;
                    renderBulkSummary(window.__lastBulkSummary);
                    showNotification('Bulk upload complete', 'success');
                    await loadApplications();
                } catch (err) {
                    showNotification('Bulk upload failed: ' + (err.message || 'Unknown error'), 'error');
                }
            });

            // Fix Problems Panel
            const openFixBtn = document.getElementById('openFixProblemsBtn');
            const drawer = document.getElementById('fixProblemsDrawer');
            const closeFixBtn = document.getElementById('closeFixPanel');
            const fixContainer = document.getElementById('fixProblemsContainer');
            const applyFixesBtn = document.getElementById('applyFixesBtn');

            function openDrawer() { drawer && (drawer.style.transform = 'translateX(0)'); }
            function closeDrawer() { drawer && (drawer.style.transform = 'translateX(100%)'); }
            if (openFixBtn) openFixBtn.addEventListener('click', () => {
                const s = window.__lastBulkSummary;
                if (!s || !Array.isArray(s.rows)) return;
                const problems = s.rows.filter(r => r.status === 'error');
                const list = window.__scholarshipList || [];
                const optionsHtml = (selectedId) => {
                    const opts = ['<option value="">-- Select scholarship --</option>']
                        .concat(list.map(s=>`<option value="${s.id}" ${String(selectedId)==String(s.id)?'selected':''}>${s.name} (ID ${s.id})</option>`)).join('');
                    return `<select data-fix="scholarship_id" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">${opts}</select>`;
                };
                const levelOptions = (val) => {
                    const lvls = ['undergraduate','graduate','phd'];
                    return `<select data-fix="academic_level" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">`
                        + lvls.map(v=>`<option value="${v}" ${String(val||'').toLowerCase()===v?'selected':''}>${v.charAt(0).toUpperCase()+v.slice(1)}</option>`).join('')
                        + `</select>`;
                };
                const itemsHtml = problems.map((r) => {
                    const d = r.data || {};
                    const original = encodeURIComponent(JSON.stringify(d));
                    const genderOptions = (val) => {
                        const opts = ['','Female','Male','Other'];
                        return `<select data-fix="gender" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">${opts.map(o=>`<option value="${o}" ${String(val||'').toLowerCase()===o.toLowerCase()?'selected':''}>${o||'-- Select gender --'}</option>`).join('')}</select>`;
                    };
                    return `
                    <div class="p-3 rounded border border-gray-200 dark:border-gray-700" data-fix-card>
                        <div class="mb-2 text-sm text-red-700 dark:text-red-400">Row #${r.row}: ${r.message||'Error'}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs">Full Name</label>
                                <input data-fix="full_name" value="${d.full_name||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Email</label>
                                <input data-fix="email_address" value="${d.email_address||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Scholarship</label>
                                ${optionsHtml(d.scholarship_id||'')}
                                <div data-fix-hint class="mt-1 text-[11px] text-gray-500"></div>
                            </div>
                            <div>
                                <label class="text-xs">Date of Birth</label>
                                <input data-fix="date_of_birth" value="${d.date_of_birth||''}" placeholder="YYYY-MM-DD" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Academic Level</label>
                                ${levelOptions(d.academic_level||'')}
                            </div>
                            <div>
                                <label class="text-xs">GPA</label>
                                <input data-fix="gpa_academic_performance" value="${d.gpa_academic_performance||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Phone</label>
                                <input data-fix="phone_number" value="${d.phone_number||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Gender</label>
                                ${genderOptions(d.gender||'')}
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs">Address</label>
                                <input data-fix="address" value="${d.address||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Preferred University</label>
                                <input data-fix="preferred_university" value="${d.preferred_university||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Country</label>
                                <input data-fix="country" value="${d.country||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Intended Major</label>
                                <input data-fix="intended_major" value="${d.intended_major||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs">Extracurricular Activities</label>
                                <input data-fix="extracurricular_activities" value="${d.extracurricular_activities||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Parent/Guardian Name</label>
                                <input data-fix="parent_guardian_name" value="${d.parent_guardian_name||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div>
                                <label class="text-xs">Parent/Guardian Contact</label>
                                <input data-fix="parent_guardian_contact" value="${d.parent_guardian_contact||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs">Financial Need Statement</label>
                                <textarea data-fix="financial_need_statement" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">${d.financial_need_statement||''}</textarea>
                            </div>
                            <div>
                                <label class="text-xs">How Heard About</label>
                                <input data-fix="how_heard_about" value="${d.how_heard_about||''}" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"/>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-xs">Motivation Statement</label>
                                <textarea data-fix="motivation_statement" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">${d.motivation_statement||''}</textarea>
                            </div>
                            <div>
                                <label class="text-xs">Terms Agreed</label>
                                <input type="checkbox" data-fix="terms_agreed" ${String(d.terms_agreed)==='1'||String(d.terms_agreed).toLowerCase()==='true'?'checked':''} />
                            </div>
                        </div>
                        <div class="mt-3 flex items-center gap-2">
                            <button class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700" data-submit-fix>Insert Row</button>
                            <span data-fix-status class="text-xs text-gray-500"></span>
                        </div>
                        <input type="hidden" data-fix-row-index value="${r.row}" />
                        <input type="hidden" data-original value="${original}" />
                    </div>`;
                }).join('') || '<div class="text-sm text-gray-500">No error rows to fix.</div>';
                if (fixContainer) fixContainer.innerHTML = itemsHtml;
                openDrawer();
            });
            if (closeFixBtn) closeFixBtn.addEventListener('click', closeDrawer);

            // Update scholarship hint when selection changes
            function updateHint(card) {
                const select = card.querySelector('[data-fix="scholarship_id"]');
                const hint = card.querySelector('[data-fix-hint]');
                const lvlSel = card.querySelector('[data-fix="academic_level"]');
                if (!select || !hint) return;
                const id = Number(select.value);
                const s = (window.__scholarshipList||[]).find(x=>Number(x.id)===id);
                if (s) {
                    const minG = (s.min_gpa!=null? `Min GPA: ${s.min_gpa}`: 'No min GPA');
                    const lvl = s.academic_level? `Required Level: ${s.academic_level}`: 'Any level';
                    hint.innerHTML = `<span class="text-green-600">${minG}</span> â€¢ <span class="text-green-600">${lvl}</span>`;
                    if (s.academic_level && lvlSel) {
                        lvlSel.value = String(s.academic_level).toLowerCase();
                        lvlSel.classList.add('ring-1','ring-green-500');
                    }
                    const gpaEl = card.querySelector('[data-fix="gpa_academic_performance"]');
                    if (gpaEl && s.min_gpa!=null) {
                        gpaEl.placeholder = `>= ${s.min_gpa}`;
                        gpaEl.classList.add('ring-1','ring-green-500');
                    }
                } else {
                    hint.textContent = '';
                }
            }

            fixContainer && fixContainer.addEventListener('change', (e)=>{
                const card = e.target.closest('[data-fix-card]');
                if (!card) return;
                if (e.target.matches('[data-fix="scholarship_id"]')) {
                    updateHint(card);
                }
            });

            // Per-row submit (fix-only fields)
            fixContainer && fixContainer.addEventListener('click', async (e)=>{
                const btn = e.target.closest('[data-submit-fix]');
                if (!btn) return;
                e.preventDefault();
                const card = btn.closest('[data-fix-card]');
                if (!card) return;
                const val = (k)=> {
                    const el = card.querySelector(`[data-fix="${k}"]`);
                    if (!el) return '';
                    if (el.type === 'checkbox') return el.checked ? '1' : '0';
                    return el.value || '';
                };
                const original = (() => { try { return JSON.parse(decodeURIComponent((card.querySelector('[data-original]')||{}).value||'{}')); } catch { return {}; }})();
                // Merge edited fix fields back into the original data, fixing only erroneous fields
                const merged = { ...original };
                ['full_name','email_address','scholarship_id','date_of_birth','academic_level','gpa_academic_performance','address','gender','phone_number','preferred_university','country','intended_major','extracurricular_activities','parent_guardian_name','parent_guardian_contact','financial_need_statement','how_heard_about','motivation_statement','terms_agreed'].forEach(k=>{
                    const newVal = val(k);
                    if (newVal !== '') merged[k] = newVal;
                });
                // Build one-row CSV from merged data (server applies constraints again)
                const header = ['full_name','email_address','scholarship_id','date_of_birth','academic_level','gpa_academic_performance','address','gender','phone_number','preferred_university','country','intended_major','extracurricular_activities','parent_guardian_name','parent_guardian_contact','financial_need_statement','how_heard_about','motivation_statement','terms_agreed'];
                const escape = v => { const s = String(v ?? ''); return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s; };
                const line = header.map(k=>escape(merged[k]||'')).join(',');
                const blob = new Blob([header.join(',')+'\n'+line], { type: 'text/csv' });
                const fd = new FormData();
                fd.append('file', blob, 'fix.csv');
                try {
                    const resp = await fetch('/api/admin-dashboard/applications/bulk-upload', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: fd
                    });
                    const result = await handleApiResponse(resp);
                    const statusEl = card.querySelector('[data-fix-status]');
                    if (result && result.summary && result.summary.inserted>0 && result.summary.errors===0) {
                        statusEl.textContent = 'Inserted successfully';
                        statusEl.className = 'text-xs text-green-600';
                        card.style.opacity = '0.6';
                        // Update global bulk summary to remove this row from errors and add to inserted
                        if (window.__lastBulkSummary) {
                            window.__lastBulkSummary.inserted = (window.__lastBulkSummary.inserted||0) + 1;
                            // Remove matching row by email + scholarship if possible, else by row index
                            const email = val('email_address');
                            const sid = Number(val('scholarship_id'));
                            if (Array.isArray(window.__lastBulkSummary.rows)) {
                                window.__lastBulkSummary.rows = window.__lastBulkSummary.rows.filter(r => {
                                    if (email && sid) return !(r.email===email && Number(r.scholarship_id)===sid && r.status==='error');
                                    return r.status !== 'error';
                                });
                                const remainingErrors = window.__lastBulkSummary.rows.filter(r=>r.status==='error').length;
                                window.__lastBulkSummary.errors = remainingErrors;
                            }
                            renderBulkSummary(window.__lastBulkSummary);
                        }
                    } else {
                        const row = result && result.summary && Array.isArray(result.summary.rows) ? result.summary.rows.find(r=>r.status==='error') : null;
                        const rowMsg = (row && row.message) || 'Failed to insert';
                        // Highlight required fields in green with expected helpers
                        const schId = Number(val('scholarship_id'));
                        const sch = (window.__scholarshipList||[]).find(x=>Number(x.id)===schId);
                        if (sch) {
                            updateHint(card);
                        }
                        const reqMap = {
                            'full_name': 'Required full name',
                            'email_address': 'Valid email required',
                            'scholarship_id': 'Select a valid scholarship',
                            'date_of_birth': 'Format YYYY-MM-DD required'
                        };
                        Object.keys(reqMap).forEach(k=>{
                            const el = card.querySelector(`[data-fix="${k}"]`);
                            if (el && !el.value) {
                                el.classList.add('ring-1','ring-green-500');
                                el.placeholder = reqMap[k];
                            }
                        });
                        statusEl.textContent = rowMsg;
                        statusEl.className = 'text-xs text-red-600';

                        // If capacity reached, offer quick expand UI
                        if (rowMsg && rowMsg.toLowerCase().includes('capacity')) {
                            const existing = card.querySelector('[data-expand-capacity]');
                            if (!existing) {
                                const wrap = document.createElement('div');
                                wrap.className = 'mt-2 flex items-center gap-2';
                                wrap.innerHTML = `
                                    <input type="number" min="1" value="1" class="w-24 px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600" data-expand-count />
                                    <button class="px-3 py-1.5 bg-purple-600 text-white rounded hover:bg-purple-700" data-expand-capacity>Expand Capacity</button>
                                    <span class="text-xs text-gray-500" data-expand-status></span>
                                `;
                                card.appendChild(wrap);
                            }
                        }
                    }
                    await loadApplications();
                } catch (err) {
                    const statusEl = card.querySelector('[data-fix-status]');
                    statusEl.textContent = 'Network error submitting fix';
                    statusEl.className = 'text-xs text-red-600';
                }
            });

            // Handle expand capacity action
            fixContainer && fixContainer.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-expand-capacity]');
                if (!btn) return;
                const card = btn.closest('[data-fix-card]');
                const countEl = card.querySelector('[data-expand-count]');
                const statusEl = card.querySelector('[data-expand-status]');
                const schId = Number((card.querySelector('[data-fix="scholarship_id"]')||{}).value || 0);
                const add = Number((countEl && countEl.value) || 0);
                if (!schId || !add || add < 1) {
                    if (statusEl) { statusEl.textContent = 'Enter a valid increment'; statusEl.className = 'text-xs text-red-600'; }
                    return;
                }
                try {
                    const resp = await fetch(`/api/admin-dashboard/scholarships/${schId}/expand-capacity`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ add })
                    });
                    const res = await handleApiResponse(resp);
                    if (statusEl) { statusEl.textContent = `Capacity updated to ${res.scholarship && res.scholarship.number_of_awards}`; statusEl.className = 'text-xs text-green-600'; }
                } catch (err2) {
                    if (statusEl) { statusEl.textContent = 'Failed to expand capacity'; statusEl.className = 'text-xs text-red-600'; }
                }
            });

            if (applyFixesBtn) applyFixesBtn.addEventListener('click', async () => {
                // Build a small CSV from the edited rows and re-run upload with the same selected scholarship override
                const s = window.__lastBulkSummary;
                if (!s || !Array.isArray(s.rows)) return;
                const problems = s.rows.filter(r => r.status === 'error');
                const groups = Array.from(fixContainer.querySelectorAll('[data-fix-row-index]')).map(hidden => hidden.closest('div'));
                const header = ['full_name','email_address','scholarship_id','date_of_birth','academic_level','gpa_academic_performance','address'];
                const escape = v => {
                    const s = String(v ?? '');
                    return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s;
                };
                const csvLines = [header.join(',')];
                groups.forEach(g => {
                    const val = key => (g.querySelector(`[data-fix="${key}"]`)||{}).value || '';
                    csvLines.push(header.map(k => escape(val(k))).join(','));
                });
                const blob = new Blob([csvLines.join('\n')], { type: 'text/csv' });
                const fd = new FormData();
                fd.append('file', blob, 'fixes.csv');
                const selectedScholarshipId = (document.getElementById('bulkScholarshipSelect')||{}).value || '';
                if (selectedScholarshipId) fd.append('scholarship_id', selectedScholarshipId);
                try {
                    const resp = await fetch('/api/admin-dashboard/applications/bulk-upload', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: fd
                    });
                    const result = await handleApiResponse(resp);
                    showNotification('Fixes processed', 'success');
                    closeDrawer();
                    window.__lastBulkSummary = result && result.summary ? result.summary : null;
                    await loadApplications();
                } catch (e) {
                    showNotification('Failed to process fixes', 'error');
                }
            });

            // Remove duplicates action
            const removeDuplicateRowsBtn2 = document.getElementById('removeDuplicateRowsBtn');
            if (removeDuplicateRowsBtn2) removeDuplicateRowsBtn2.addEventListener('click', async () => {
                const s = window.__lastBulkSummary;
                if (!s || !Array.isArray(s.rows)) return;
                const dupItems = s.rows.filter(r => r.status === 'duplicate' && r.email && r.scholarship_id)
                    .map(r => ({ email_address: r.email, scholarship_id: r.scholarship_id }));
                if (!dupItems.length) {
                    showNotification('No duplicates to remove', 'error');
                    return;
                }
                try {
                    const resp = await fetch('/api/admin-dashboard/applications/bulk-delete-duplicates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ items: dupItems })
                    });
                    const res = await handleApiResponse(resp);
                    showNotification(`Removed ${res.deleted||0} duplicate entries`, 'success');
                    await loadApplications();
                } catch (e) {
                    showNotification('Failed to remove duplicates', 'error');
                }
            });

            // Export problem rows (duplicates + errors)
            const exportProblemRowsBtn2 = document.getElementById('exportProblemRowsBtn');
            function toCsvRow(arr){
                return arr.map(v => {
                    const s = String(v ?? '');
                    if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                        return '"' + s.replace(/"/g,'""') + '"';
                    }
                    return s;
                }).join(',');
            }
            if (exportProblemRowsBtn2) exportProblemRowsBtn2.addEventListener('click', () => {
                const s = window.__lastBulkSummary;
                if (!s || !Array.isArray(s.rows)) return;
                const rows = s.rows.filter(r => r.status === 'duplicate' || r.status === 'error');
                const header = ['row','status','email','scholarship_id','message'];
                const data = [header.join(',')].concat(rows.map(r => toCsvRow([r.row||'', r.status||'', r.email||'', r.scholarship_id||'', r.message||''])));
                const blob = new Blob([data.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk_upload_problems.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            // Status modal event listeners
            const statusUpdateForm = document.getElementById('statusUpdateForm');
            const closeStatusModal = document.getElementById('closeStatusModal');
            const cancelStatusUpdate = document.getElementById('cancelStatusUpdate');
            const statusUpdateModal = document.getElementById('statusUpdateModal');
            
            if (statusUpdateForm) {
                statusUpdateForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const applicationId = document.getElementById('statusApplicationId').value;
                    const status = document.getElementById('statusSelect').value;
                    const reviewerNotes = document.getElementById('reviewerNotes').value;

                    try {
                        const response = await fetch(`/api/admin-dashboard/applications/${applicationId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                status: status,
                                reviewer_notes: reviewerNotes
                            })
                        });

                        const result = await handleApiResponse(response);
                        if (result) {
                            showNotification('Application status updated successfully', 'success');
                            statusUpdateModal.classList.remove('show');
                            await loadApplications(); // Refresh the applications list
                        }
                    } catch (error) {
                        console.error('Error updating application status:', error);
                        showNotification('Failed to update application status', 'error');
                    }
                });
            }
            
            if (closeStatusModal) {
                closeStatusModal.addEventListener('click', function() {
                    statusUpdateModal.classList.remove('show');
                });
            }
            
            if (cancelStatusUpdate) {
                cancelStatusUpdate.addEventListener('click', function() {
                    statusUpdateModal.classList.remove('show');
                });
            }
            
            if (statusUpdateModal) {
                statusUpdateModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            }
            
            // Message modal event listeners
            const sendMessageForm = document.getElementById('sendMessageForm');
            const closeMessageModal = document.getElementById('closeMessageModal');
            const cancelMessage = document.getElementById('cancelMessage');
            const sendMessageModal = document.getElementById('sendMessageModal');
            
            if (sendMessageForm) {
                sendMessageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const applicationId = document.getElementById('messageApplicationId').value;
                    const userEmail = document.getElementById('messageUserEmail').value;
                    const title = document.getElementById('messageTitle').value;
                    const message = document.getElementById('messageContent').value;

                    try {
                        const response = await fetch('/api/notifications', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: userEmail,
                                title: title,
                                message: message
                            })
                        });

                        const result = await handleApiResponse(response);
                        if (result) {
                            const message = result.userFound 
                                ? 'Message sent successfully to registered user!' 
                                : 'Message sent successfully! (Notification created for applicant)';
                            showNotification(message, 'success');
                            sendMessageModal.classList.remove('show');
                        }
                    } catch (error) {
                        console.error('Error sending message:', error);
                        showNotification('Failed to send message: ' + (error.message || 'Unknown error'), 'error');
                    }
                });
            }
            
            if (closeMessageModal) {
                closeMessageModal.addEventListener('click', function() {
                    sendMessageModal.classList.remove('show');
                });
            }
            
            if (cancelMessage) {
                cancelMessage.addEventListener('click', function() {
                    sendMessageModal.classList.remove('show');
                });
            }
            
            if (sendMessageModal) {
                sendMessageModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            }
            
            setupMultiStepNavigation();
        }

        async function loadApplications() {
            try {
                showLoading(true);
                hideFetchError();
                // Use admin-dashboard endpoint that returns JSON consistently
                const response = await fetch('/api/admin-dashboard/applications/recent', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const payload = await handleApiResponse(response);
                const result = payload && payload.data ? payload.data : payload;
                if (!Array.isArray(result)) {
                    console.warn('Applications API did not return an array:', result);
                    applications = [];
                } else {
                    applications = mapApplicationsToCamelCase(result);
                }
                filterApplications();
            } catch (error) {
                console.error('Error loading applications:', error);
                showFetchError('Unable to load applications. Please try again later.', loadApplications);
            } finally {
                showLoading(false);
            }
        }

        function filterApplications() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredApplications = applications.filter(app => 
                Object.values(app).some(val => String(val).toLowerCase().includes(searchTerm))
            );
            // Removed score-based filtering
            // Apply sorting
            filteredApplications.sort((a,b)=>{
                // Default sorting (no score sorting since match % removed)
                const da = a.applicationDate ? new Date(a.applicationDate).getTime() : 0;
                const db = b.applicationDate ? new Date(b.applicationDate).getTime() : 0;
                switch (sortMode) {
                    case 'date_asc': return da - db;
                    case 'date_desc': return db - da;
                    default: return 0;
                }
            });
            currentPage = 1;
            updateApplicationsTable();
            updatePagination();
        }

        function updateApplicationsTable() {
            const startIndex = (currentPage - 1) * applicationsPerPage;
            const applicationsToDisplay = filteredApplications.slice(startIndex, startIndex + applicationsPerPage);
            
            noApplications.classList.toggle('hidden', filteredApplications.length > 0);

            const tableHtml = applicationsToDisplay.map(app => {
                const profileImgSrc = app.profilePictureUrl ? `/${app.profilePictureUrl}` : defaultAvatar;
                const university = app.preferredUniversity || app.scholarshipTitle || 'N/A';
                const appDate = app.applicationDate ? new Date(app.applicationDate).toLocaleDateString() : 'N/A';
                

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">${app.fullName}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${app.emailAddress}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">${university}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${getStatusClass(app.status || 'pending')}">${getStatusText(app.status || 'pending')}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            ${appDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewApplication(${app.applicationId || 0})" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 mr-3" title="View"><i class="fas fa-eye"></i></button>
                            <button onclick="openEditApplicant(${app.applicationId || 0})" class="text-warning-600 hover:text-warning-900 dark:text-warning-400 dark:hover:text-warning-300 mr-3" title="Edit Applicant"><i class="fas fa-edit"></i></button>
                            <button onclick="updateApplicationStatus(${app.applicationId || 0})" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 mr-3" title="Change Status"><i class="fas fa-exchange-alt"></i></button>
                            <button onclick="sendMessageToUser(${app.applicationId || 0}, '${app.emailAddress || ''}', '${app.fullName || ''}')" class="text-info-600 hover:text-info-900 dark:text-info-400 dark:hover:text-info-300 mr-3" title="Message"><i class="fas fa-envelope"></i></button>
                            <button onclick="deleteApplication(${app.applicationId || 0})" class="text-danger-600 hover:text-danger-900 dark:text-danger-400 dark:hover:text-danger-300" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            applicationsTable.innerHTML = tableHtml;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'pending';
                case 'under_review': return 'under-review';
                case 'approved': return 'approved';
                case 'rejected': return 'rejected';
                case 'waitlisted': return 'waitlisted';
                default: return 'pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'under_review': return 'Under Review';
                case 'approved': return 'Approved';
                case 'rejected': return 'Rejected';
                case 'waitlisted': return 'Waitlisted';
                default: return 'Pending';
            }
        }

        function updatePagination() {
            const total = filteredApplications.length;
            const totalPages = Math.ceil(total / applicationsPerPage);
            const startItem = total === 0 ? 0 : (currentPage - 1) * applicationsPerPage + 1;
            const endItem = Math.min(currentPage * applicationsPerPage, total);

            startRange.textContent = startItem;
            endRange.textContent = endItem;
            totalApplications.textContent = total;

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            prevPageBtn.classList.toggle('opacity-50', prevPageBtn.disabled);
            nextPageBtn.classList.toggle('opacity-50', nextPageBtn.disabled);
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(filteredApplications.length / applicationsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateApplicationsTable();
                updatePagination();
            }
        }

        async function viewApplication(applicationId) {
            try {
                showLoading(true);
                const response = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(applicationId)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await handleApiResponse(response);
                if (!result) return;
                
                // Support both wrapped {success,data} and raw object
                const raw = (result && result.data) ? result.data : result;
                
                // Convert to camelCase for consistent field access
                const app = toCamelCase(raw);
                
                let documentsHtml = 'No documents uploaded';
                if (app.uploadedDocumentsJson) {
                    try {
                        const docs = JSON.parse(app.uploadedDocumentsJson);
                        if (Array.isArray(docs) && docs.length > 0) {
                            documentsHtml = docs.map(doc => `<a href="/${doc}" target="_blank" class="underline text-primary-600">${doc.split('/').pop()}</a>`).join('<br>');
                        }
                    } catch (e) { console.error("Error parsing documents JSON", e); }
                }

                applicationDetails.innerHTML = `
                    <div class="space-y-4">
                        <div class="application-card flex flex-col items-center text-center">
                            <div class="relative w-32 h-32 mx-auto mb-3 group">
                                <img id="modalProfileImg" src="${app.profilePictureUrl ? '/' + app.profilePictureUrl : ''}" alt="Profile" class="w-32 h-32 rounded-full object-cover border-4 border-primary-500 shadow bg-gray-100 group-hover:scale-105 transition-transform duration-200" onerror="this.style.display='none';document.getElementById('modalProfileFallback').style.display='flex';">
                                <div id="modalProfileFallback" style="display:none;" class="absolute inset-0 flex items-center justify-center rounded-full bg-primary-100 text-primary-600 text-4xl font-bold select-none">
                                    ${app.fullName ? app.fullName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase() : '?'}
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="text-xl font-bold text-gray-900 dark:text-white">${app.fullName}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-300 mt-1"><i class="fas fa-envelope mr-1"></i>${app.emailAddress}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-300 mt-1"><i class="fas fa-phone mr-1"></i>${app.phoneNumber || 'N/A'}</div>
                            </div>
                            <div class="text-sm text-gray-400">Date of Birth: <span class="text-gray-700 dark:text-gray-200">${app.dateOfBirth || 'N/A'}</span></div>
                        </div>
                        <div class="application-card"><h3 class="text-lg font-semibold">Academic Information</h3><p><strong>Preferred University:</strong> ${app.preferredUniversity || ''}</p><p><strong>Country:</strong> ${app.country || ''}</p></div>
                        <div class="application-card"><h3 class="text-lg font-semibold">Uploaded Documents</h3>${documentsHtml}</div>
                    </div>`;
                showModal();
            } catch (error) {
                console.error('Error viewing application:', error);
                showFetchError('Unable to load application details.');
            } finally {
                showLoading(false);
            }
        }

        async function deleteApplication(applicationId) {
            if (!confirm('Are you sure you want to delete this application?')) return;
            try {
                const response = await fetch(`/api/admin-dashboard/applications/${applicationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                await handleApiResponse(response);
                showNotification('Application deleted successfully', 'success');
                loadApplications();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function showLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        /* async function exportApplicationsWithScores() {
            try {
                const token = localStorage.getItem('token');
                const perPage = 200;
                let page = 1;
                let all = [];
                while (true) {
                    const resp = await fetch(`/api/admin-dashboard/applications?page=${page}&limit=${perPage}`, {
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                    });
                    const payload = await handleApiResponse(resp);
                    const items = Array.isArray(payload?.data) ? payload.data : Array.isArray(payload) ? payload : [];
                    if (!items.length) break;
                    all = all.concat(items);
                    if (items.length < perPage) break;
                    page += 1;
                }
                // Apply current score threshold (if any)
                const threshold = parseInt(minScoreFilter || '0', 10) || 0;
                if (threshold > 0) {
                    all = all.filter(a => {
                        const sp = getMatchScore(a);
                        return !Number.isNaN(sp) && sp >= threshold;
                    });
                }
                if (!all.length) { showNotification('No applications to export', 'info'); return; }
                const rows = [
                    ['Applicant Name','Email','Scholarship','Country','Status','Applied Date','Match %']
                ];
                all.forEach(a=>{
                    const date = a.created_at ? new Date(a.created_at).toISOString().split('T')[0] : '';
                    const score = (function(){ const n = getMatchScore(a); return Number.isNaN(n)?'':n; })();
                    const country = getCountry(a);
                    rows.push([a.applicant_name||'', a.applicant_email||'', a.scholarship_title||'', country, a.status||'', date, score]);
                });
                const csv = rows.map(r=>r.map(v=>{
                    const s = String(v ?? '');
                    return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s;
                }).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const suffix = threshold > 0 ? `_gte_${threshold}` : '';
                a.download = `applications_with_match${suffix}_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showNotification('Failed to export: ' + (e.message||'Unknown error'), 'error');
            }
        } */

        function showModal() { if (applicationModal) { applicationModal.classList.add('show'); applicationModal.style.display = 'flex'; } }
        function hideModal() {
            if (!applicationModal) return;
            applicationModal.classList.remove('show');
            // Hard-hide to avoid stuck state
            applicationModal.style.opacity = '0';
            applicationModal.style.visibility = 'hidden';
            applicationModal.style.display = 'none';
        }



        function showCreateModal() {
            if (createApplicationModal) {
                // First, show the modal
                createApplicationModal.classList.add('show');
                // Force visibility with inline styles as backup
                createApplicationModal.style.opacity = '1';
                createApplicationModal.style.visibility = 'visible';
                createApplicationModal.style.display = 'flex';
                createApplicationModal.style.zIndex = '9999';
                
                // Then, after a short delay, set up the form steps
                setTimeout(() => {
            currentStepIndex = 0;
            showStep(0);
                }, 100);
            } else {
                console.error('createApplicationModal element not found!');
            }
        }
        function hideCreateModal() {
            if (!createApplicationModal) return;
            createApplicationModal.classList.remove('show');
            // Fully clear inline styles to avoid lingering blur/visibility
            createApplicationModal.style.opacity = '0';
            createApplicationModal.style.visibility = 'hidden';
            createApplicationModal.style.display = 'none';
            // Also reset any document/body classes if used elsewhere
            document.body.classList.remove('modal-open');
        }

        async function handleApplicationSubmit(e) {
            e.preventDefault();
            const form = e.target;
            if (!Array.from(form.querySelectorAll('[required]')).every(el => el.checkValidity())) {
                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    const invalidInput = Array.from(step.querySelectorAll('[required]')).find(el => !el.checkValidity());
                    if (invalidInput) {
                        showStep(i);
                        invalidInput.reportValidity();
                        return;
                    }
                }
            }

            const formData = new FormData(form);
            // Debug: log all form data before submit
            for (let [key, value] of formData.entries()) {
                console.log('FORM FIELD:', key, value);
            }
            const applicationId = form.dataset.applicationId;
            const url = applicationId ? `/api/admin-dashboard/applications/${applicationId}` : '/api/admin-dashboard/applications';
            const method = applicationId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                const apiResult = await handleApiResponse(response);
                // Prefer showing suitability percent to inform likelihood
                const data = apiResult && typeof apiResult === 'object' && 'data' in apiResult ? apiResult.data : apiResult;
                const score = data && typeof data.suitability_percent === 'number' ? data.suitability_percent : null;
                if (score !== null && !applicationId) {
                    showNotification(`Application created. Estimated match score: ${score}%`, 'success');
                } else {
                showNotification(`Application ${applicationId ? 'updated' : 'created'} successfully`, 'success');
                }
                hideCreateModal();
                loadApplications();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function loadScholarshipsAndPopulateSelects(selectedUniversity = null) {
            try {
                const response = await fetch('/api/scholarships');
                const scholarships = await response.json();
                const universitySelect = document.getElementById('preferredUniversity');
                const scholarshipIdInput = document.getElementById('scholarship_id');
                const countryInput = document.getElementById('countryFilter');

                universitySelect.innerHTML = '<option value="">Select a university</option>';
                scholarships.forEach(sch => {
                    const option = document.createElement('option');
                    option.value = sch.name;
                    option.textContent = sch.name;
                    option.dataset.scholarshipId = sch.id;
                    option.dataset.country = sch.country || '';
                    if (selectedUniversity === sch.name) {
                        option.selected = true;
                    }
                    universitySelect.appendChild(option);
                });

                async function syncFields() {
                    const selectedOption = universitySelect.options[universitySelect.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        scholarshipIdInput.value = selectedOption.dataset.scholarshipId;
                        // We no longer auto-fill the country. It's an independent selection.
                    } else {
                        scholarshipIdInput.value = '';
                    }

                    // If email present, check duplicate for this scholarship
                    const emailEl = document.getElementById('emailAddress');
                    const email = emailEl?.value?.trim();
                    const id = scholarshipIdInput.value;
                    if (email && id) {
                        try {
                            const resp = await fetch(`/api/scholarships/${encodeURIComponent(id)}/has-applied?email=${encodeURIComponent(email)}`);
                            const data = await resp.json();
                            if (data && data.hasApplied) {
                                showNotification('This applicant already applied for the selected scholarship.', 'error');
                            }
                        } catch {}
                    }
                }
                universitySelect.addEventListener('change', syncFields);
                if (selectedUniversity) syncFields();
            } catch (error) {
                showNotification('Failed to load scholarships', 'error');
            }
        }

        // Also check duplicate when admin enters email, if scholarship selected
        (function(){
            const emailEl = document.getElementById('emailAddress');
            emailEl?.addEventListener('blur', async function() {
                const email = emailEl.value.trim();
                const id = document.getElementById('scholarship_id')?.value?.trim();
                if (!email || !id) return;
                try {
                    const resp = await fetch(`/api/scholarships/${encodeURIComponent(id)}/has-applied?email=${encodeURIComponent(email)}`);
                    const data = await resp.json();
                    if (data && data.hasApplied) {
                        showNotification('This applicant already applied for the selected scholarship.', 'error');
                    }
                } catch {}
            });
        })();

        async function updateApplication(applicationId) {
            try {
                showLoading(true);
                const response = await fetch(`/api/admin-dashboard/applications/${applicationId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const appData = await handleApiResponse(response);
                if (!appData) return;
                
                profilePictureInput.required = false;

                await loadScholarshipsAndPopulateSelects(appData.preferred_university);
                
                const fieldMapping = {
                    full_name: 'fullName', email_address: 'emailAddress', date_of_birth: 'dob', gender: 'gender',
                    phone_number: 'phone', address: 'address', preferred_university: 'preferredUniversity',
                    country: 'countryFilter', academic_level: 'academicLevel', intended_major: 'intendedMajor',
                    gpa_academic_performance: 'gpaAcademicPerformance', extracurricular_activities: 'extracurricularActivities',
                    parent_guardian_name: 'parentGuardianName', parent_guardian_contact: 'parentGuardianContact',
                    financial_need_statement: 'financialNeedStatement', how_heard_about: 'howHeardAbout',
                    motivation_statement: 'motivationStatement'
                };

                for (const [key, id] of Object.entries(fieldMapping)) {
                    const el = document.getElementById(id);
                    if (el) el.value = appData[key] || '';
                }
                document.querySelector('input[name="terms_agreed"]').checked = !!appData.terms_agreed;

                if (profilePreview) {
                    const imageUrl = appData.profile_picture_url ? `/${appData.profile_picture_url}` : defaultAvatar;
                    profilePreview.src = imageUrl;
                    profilePreview.onerror = () => {
                        profilePreview.src = defaultAvatar;
                    };
                    profilePreview.classList.remove('hidden');
                    profilePlaceholder.classList.add('hidden');
                }
                
                adminScholarshipForm.dataset.applicationId = applicationId;
                document.querySelector('#createApplicationModal h2').textContent = 'Update Application';
                adminScholarshipForm.querySelector('button[type="submit"]').textContent = 'Update Application';
                showCreateModal();
            } catch (error) {
                console.error('Error loading application for update:', error);
                showFetchError('Unable to load application details.');
            } finally {
                showLoading(false);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }



        function showFetchError(message, retryCallback) {
            const el = document.getElementById('fetchError');
            el.querySelector('span').textContent = message;
            el.classList.remove('hidden');
            const retryBtn = el.querySelector('button');
            retryBtn.classList.toggle('hidden', !retryCallback);
            if(retryCallback) retryBtn.onclick = () => {
                el.classList.add('hidden');
                    retryCallback();
                };
        }
        function hideFetchError() {
            document.getElementById('fetchError').classList.add('hidden');
        }

        function showFetchError(message, retryCallback = null) {
            const el = document.getElementById('fetchError');
            const messageEl = document.getElementById('fetchErrorMessage');
            const retryBtn = document.getElementById('retryFetchBtn');
            
            messageEl.textContent = message;
            el.classList.remove('hidden');
            
            if(retryCallback) retryBtn.onclick = () => {
                el.classList.add('hidden');
                retryCallback();
            };
        }

        async function handleApiResponse(response) {
            if (!response.ok) {
                // If permission denied, session is likely invalid, so log out.
                if (response.status === 401 || response.status === 403) {
                    showNotification('Session expired or permission denied. Please log in again.', 'error');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    // Use a short delay to allow the user to see the notification
                    setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                }
                const errorResult = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorResult.message || 'An unknown error occurred');
            }
            if (response.status === 204) return null; 
            return response.json();
        }

        // Status Management Functions
        async function updateApplicationStatus(applicationId) {
            try {
                // Get current application data
                const response = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(applicationId)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const apiResult = await handleApiResponse(response);
                const appData = apiResult && typeof apiResult === 'object' && 'data' in apiResult ? apiResult.data : apiResult;
                if (!appData) return;

                // Convert to camelCase for consistent field access
                const app = toCamelCase(appData);

                // Populate the status update modal
                document.getElementById('statusApplicationId').value = applicationId;
                document.getElementById('statusSelect').value = app.status || 'pending';
                document.getElementById('reviewerNotes').value = app.reviewerNotes || '';

                // Show the modal
                document.getElementById('statusUpdateModal').classList.add('show');
            } catch (error) {
                console.error('Error loading application for status update:', error);
                showNotification('Unable to load application details.', 'error');
            }
        }

        // Edit Applicant Modal Logic
        function bindEditApplicantModal() {
            const modal = document.getElementById('editApplicantModal');
            const closeBtn = document.getElementById('closeEditApplicant');
            const cancelBtn = document.getElementById('cancelEditApplicant');
            function close() { modal.classList.remove('show'); }
            if (closeBtn) closeBtn.onclick = close;
            if (cancelBtn) cancelBtn.onclick = close;
            const form = document.getElementById('editApplicantForm');
            if (form && !form.dataset.bound) {
                form.dataset.bound = '1';
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const id = document.getElementById('editApplicationId').value;
                        const payload = {
                            full_name: document.getElementById('eaFullName').value.trim(),
                            email_address: document.getElementById('eaEmail').value.trim(),
                            phone_number: document.getElementById('eaPhone').value.trim(),
                            date_of_birth: document.getElementById('eaDob').value,
                            gender: document.getElementById('eaGender').value,
                            address: document.getElementById('eaAddress').value.trim(),
                            preferred_university: document.getElementById('eaUniversity').value.trim(),
                            country: document.getElementById('eaCountry').value.trim(),
                            academic_level: document.getElementById('eaAcademicLevel').value.trim(),
                            intended_major: document.getElementById('eaIntendedMajor').value.trim(),
                            gpa_academic_performance: document.getElementById('eaGpa').value.trim(),
                            extracurricular_activities: document.getElementById('eaExtracurriculars').value,
                            parent_guardian_name: document.getElementById('eaParentName').value.trim(),
                            parent_guardian_contact: document.getElementById('eaParentContact').value.trim(),
                            financial_need_statement: document.getElementById('eaFinancialNeed').value,
                            how_heard_about: document.getElementById('eaHowHeard').value.trim(),
                            motivation_statement: document.getElementById('eaMotivation').value,
                            terms_agreed: document.getElementById('eaTerms').checked ? 1 : 0
                        };
                        const resp = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(id)}/details`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(payload)
                        });
                        await handleApiResponse(resp);
                        showNotification('Applicant updated successfully.', 'success');
                        close();
                        await loadApplications(currentPage);
                    } catch (err) {
                        console.error('save edit applicant error:', err);
                        showNotification(err.message || 'Failed to save changes', 'error');
                    }
                });
            }
        }

        async function openEditApplicant(applicationId) {
            try {
                const resp = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(applicationId)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const apiResult = await handleApiResponse(resp);
                const raw = apiResult && typeof apiResult === 'object' && 'data' in apiResult ? apiResult.data : apiResult;
                const app = toCamelCase(raw || {});
                if (!raw || Object.keys(raw || {}).length === 0) {
                    showNotification('No existing data found for this application.', 'warning');
                }
                document.getElementById('editApplicationId').value = applicationId;

                const fieldMap = [
                    { id: 'eaFullName', keys: ['fullName', 'full_name'] },
                    { id: 'eaEmail', keys: ['emailAddress', 'email_address'] },
                    { id: 'eaPhone', keys: ['phoneNumber', 'phone_number'] },
                    { id: 'eaDob', keys: ['dateOfBirth', 'date_of_birth'], map: (v)=> (v ? String(v).slice(0,10) : '') },
                    { id: 'eaGender', keys: ['gender'] },
                    { id: 'eaAddress', keys: ['address'] },
                    { id: 'eaUniversity', keys: ['preferredUniversity', 'preferred_university'] },
                    { id: 'eaCountry', keys: ['country'] },
                    { id: 'eaAcademicLevel', keys: ['academicLevel', 'academic_level'] },
                    { id: 'eaIntendedMajor', keys: ['intendedMajor', 'intended_major'] },
                    { id: 'eaGpa', keys: ['gpaAcademicPerformance', 'gpa_academic_performance'] },
                    { id: 'eaExtracurriculars', keys: ['extracurricularActivities', 'extracurricular_activities'] },
                    { id: 'eaParentName', keys: ['parentGuardianName', 'parent_guardian_name'] },
                    { id: 'eaParentContact', keys: ['parentGuardianContact', 'parent_guardian_contact'] },
                    { id: 'eaFinancialNeed', keys: ['financialNeedStatement', 'financial_need_statement'] },
                    { id: 'eaHowHeard', keys: ['howHeardAbout', 'how_heard_about'] },
                    { id: 'eaMotivation', keys: ['motivationStatement', 'motivation_statement'] }
                ];

                const setValue = (id, val) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') {
                        el.checked = !!val;
                    } else {
                        const finalVal = (val === undefined || val === null) ? '' : String(val);
                        el.value = finalVal;
                        // also reflect the existing value in placeholder for visual confirmation
                        if ('placeholder' in el) el.placeholder = finalVal;
                    }
                };

                const getFirst = (keys) => {
                    for (const k of keys) {
                        if (k in app && app[k] !== undefined && app[k] !== null && String(app[k]).length) return app[k];
                        if (k in raw && raw[k] !== undefined && raw[k] !== null && String(raw[k]).length) return raw[k];
                    }
                    return '';
                };

                console.debug('edit modal payload (raw):', raw);
                console.debug('edit modal payload (camel):', app);

                fieldMap.forEach(({id, keys, map}) => {
                    const rawVal = getFirst(keys);
                    setValue(id, map ? map(rawVal) : rawVal);
                });
                setValue('eaTerms', !!(app.termsAgreed ?? raw.terms_agreed));

                // Extra-guarantee population for critical fields requested
                const ensure = (id, v) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!el.value) el.value = v ?? '';
                    if ('placeholder' in el && !el.placeholder) el.placeholder = el.value;
                };
                ensure('eaAddress', app.address ?? raw.address);
                ensure('eaUniversity', app.preferredUniversity ?? raw.preferred_university);
                ensure('eaCountry', app.country ?? raw.country);
                ensure('eaIntendedMajor', app.intendedMajor ?? raw.intended_major);
                ensure('eaGpa', app.gpaAcademicPerformance ?? raw.gpa_academic_performance);
                ensure('eaExtracurriculars', app.extracurricularActivities ?? raw.extracurricular_activities);
                ensure('eaParentName', app.parentGuardianName ?? raw.parent_guardian_name);
                ensure('eaParentContact', app.parentGuardianContact ?? raw.parent_guardian_contact);
                ensure('eaFinancialNeed', app.financialNeedStatement ?? raw.financial_need_statement);
                ensure('eaHowHeard', app.howHeardAbout ?? raw.how_heard_about);
                ensure('eaMotivation', app.motivationStatement ?? raw.motivation_statement);

                bindEditApplicantModal();
                document.getElementById('editApplicantModal').classList.add('show');
            } catch (err) {
                console.error('openEditApplicant error:', err);
                showNotification('Unable to load applicant details.', 'error');
            }
        }

        // Quick Edit Applicant (inline prompts for now)
        async function editApplicant(applicationId, currentName = '', currentEmail = '') {
            try {
                // Fetch latest row to prefill more fields
                const resp = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(applicationId)}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const apiResult = await handleApiResponse(resp);
                const raw = apiResult && typeof apiResult === 'object' && 'data' in apiResult ? apiResult.data : apiResult;
                const app = toCamelCase(raw || {});

                const name = prompt('Full name:', currentName || app.fullName || '');
                if (name === null) return; // canceled
                const email = prompt('Email address:', currentEmail || app.emailAddress || '');
                if (email === null) return;
                const phone = prompt('Phone number:', app.phoneNumber || '');
                if (phone === null) return;
                const dob = prompt('Date of birth (YYYY-MM-DD):', app.dateOfBirth || '');
                if (dob === null) return;
                const university = prompt('University:', app.preferredUniversity || '');
                if (university === null) return;
                const country = prompt('Country:', app.country || '');
                if (country === null) return;

                const res = await fetch(`/api/admin-dashboard/applications/${encodeURIComponent(applicationId)}/details`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        full_name: name,
                        email_address: email,
                        phone_number: phone,
                        date_of_birth: dob,
                        preferred_university: university,
                        country: country
                    })
                });
                await handleApiResponse(res);
                showNotification('Applicant details updated.', 'success');
                await loadApplications(currentPage);
            } catch (err) {
                console.error('editApplicant error:', err);
                showNotification(err.message || 'Failed to update applicant', 'error');
            }
        }

        // Message Management Functions
        function sendMessageToUser(applicationId, userEmail, userName) {
            // Populate the message modal
            document.getElementById('messageApplicationId').value = applicationId;
            document.getElementById('messageUserEmail').value = userEmail;
            document.getElementById('messageApplicantInfo').innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                        <span class="text-primary-600 dark:text-primary-400 font-semibold">${userName ? userName.charAt(0).toUpperCase() : 'U'}</span>
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900 dark:text-white">${userName || 'Unknown User'}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${userEmail}</div>
                    </div>
                </div>
            `;

            // Clear previous form data
            document.getElementById('messageTitle').value = '';
            document.getElementById('messageContent').value = '';

            // Show the modal
            document.getElementById('sendMessageModal').classList.add('show');
        }

        function setMessageTemplate(type) {
            const titleInput = document.getElementById('messageTitle');
            const messageInput = document.getElementById('messageContent');
            
            const templates = {
                approved: {
                    title: 'Application Approved',
                    message: 'Congratulations! Your scholarship application has been approved. We are pleased to inform you that your application has met all our requirements and you have been selected for the scholarship. You will receive further details about the next steps via email. Thank you for your interest in our program.'
                },
                rejected: {
                    title: 'Application Status Update',
                    message: 'Thank you for your interest in our scholarship program. After careful review of your application, we regret to inform you that we are unable to approve your application at this time. We encourage you to apply again in the future. We wish you the best in your academic pursuits.'
                },
                under_review: {
                    title: 'Application Under Review',
                    message: 'Your scholarship application is currently under review by our selection committee. This process typically takes 2-3 weeks. We will notify you as soon as a decision has been made. Thank you for your patience.'
                },
                waitlisted: {
                    title: 'Application Waitlisted',
                    message: 'Your scholarship application has been placed on our waitlist. This means that while your application meets our criteria, we have limited spots available. We will contact you if a position becomes available. Thank you for your understanding.'
                }
            };
            
            if (templates[type]) {
                titleInput.value = templates[type].title;
                messageInput.value = templates[type].message;
            }
        }

        let sortMode = '';

    </script>
</body>
</html>
